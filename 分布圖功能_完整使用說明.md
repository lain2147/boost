# 分布圖功能 - 完整使用說明

**版本**:2.0 (新佈局設計 - 兩欄數據表)
**最後更新**:2025-12-08
**程式碼檔案**:`分布圖功能_完整VBA程式碼.txt`

---

## 📋 目錄

1. [功能簡介](#功能簡介)
2. [使用步驟](#使用步驟)
3. [新佈局特色](#新佈局特色)
4. [支援的測試類型](#支援的測試類型)
5. [整合到現有系統](#整合到現有系統)
6. [常見問題](#常見問題)
7. [技術細節](#技術細節)

---

## 功能簡介

### 這個功能做什麼?

分布圖功能會自動為所有測試序列(SEQ)生成統計分布圖,包括:

- ✅ 數據表(Reading + Frequency)
- ✅ 頻率統計(自動四捨五入與去重)
- ✅ Spec Max/Min 標記(顯示在數據表中)
- ✅ 柱狀圖 + 趨勢折線圖
- ✅ 水平佈局(每個 SEQ 平行排列)

### 新版本改進

與舊版相比,新版本有以下改進:

| 特性 | 舊版 | 新版 |
|------|------|------|
| 數據表結構 | 5 欄(隱藏計算) | **2 欄**(Reading + Frequency) |
| Spec 顯示 | 虛線 | **標記在數據表中** (`5.5_MAX`, `5.2_Min`) |
| 數據排序 | 從小到大 | **從大到小** |
| 圖表位置 | 固定位置 | **數據表右側**(自動對齊) |
| SEQ 佈局 | 垂直排列 | **水平排列**(平行新增) |

---

## 使用步驟

### 步驟 1:打開 Excel VBA 編輯器

1. 打開您的 Excel 測試報告工具(`EXCEL_TO_TXT.xlsm`)
2. 按 `Alt + F11` 打開 VBA 編輯器

### 步驟 2:複製程式碼

1. 打開 `分布圖功能_完整VBA程式碼.txt`
2. **全選**(Ctrl+A)並**複製**(Ctrl+C)

### 步驟 3:貼上到 VBA 模組

1. 在 VBA 編輯器左側找到您的模組(通常是 `Module1`)
2. 在模組**底部**貼上程式碼(Ctrl+V)
3. **存檔**(Ctrl+S)

⚠️ **注意**:請貼在模組底部,不要覆蓋既有的函數!

### 步驟 4:在主處理流程中調用

在主處理流程的**最後**(產生完所有測試報告後),加入以下程式碼:

```vba
' ===== 主處理流程最後 =====
' ... (既有的處理流程) ...

' 產生分布圖
Call CreateDistributionChartsForAllSequences_New(allSequences, lines)

' 存檔
wb.Save
```

### 步驟 5:測試執行

1. 關閉 VBA 編輯器(Alt+Q)
2. 執行您的測試報告工具
3. 選擇 TXT 測試檔案
4. 等待處理完成
5. 開啟生成的 Excel 檔案
6. 切換到「**分佈圖**」工作表

---

## 新佈局特色

### 1. 兩欄數據表設計

**舊版**(5 欄):
```
| A(隱藏) | B(隱藏) | C(隱藏) | D(隱藏) | E(隱藏) | F | G | H-O(圖表) |
```

**新版**(2 欄):
```
| Reading | Frequency | (圖表在右側) |
|---------|-----------|--------------|
| 4.55    | 1         |              |
| 5.2_Min |           | ← 綠色粗體  |
| 5.28    | 3         |              |
| 5.5_MAX |           | ← 紅色粗體  |
```

### 2. Spec Max/Min 標記顯示在數據表中

**舊版**:Spec 顯示為圖表中的虛線
**新版**:Spec 顯示為數據表中的特殊行

| 標記 | 範例 | 顏色 | 頻率 |
|------|------|------|------|
| `_MAX` | `5.5_MAX` | 紅色粗體 | 空白 |
| `_Min` | `5.2_Min` | 綠色粗體 | 空白 |

### 3. 從大到小排序

所有數據(包含 Spec 標記)從**大到小**排序:

```
5.5_MAX   ← 最大值
5.30
5.29
5.28
5.2_Min   ← 最小值
4.84
4.55      ← 最小讀值
```

### 4. 水平佈局

**舊版**:所有 SEQ 垂直排列(往下)
**新版**:不同 SEQ 水平排列(往右)

```
┌──────────┐  ┌──────────┐  ┌──────────┐
│ SEQ.2    │  │ SEQ.3    │  │ SEQ.4    │
│ Load Reg │  │ Input/Out│  │ Turn On  │
├──────────┤  ├──────────┤  ├──────────┤
│ VdcRead1 │  │ Iinrms   │  │ Reading  │
│ 數據+圖表 │  │ 數據+圖表 │  │ 數據+圖表 │
├──────────┤  ├──────────┤  └──────────┘
│ VppRead1 │  │ Pin      │
│ 數據+圖表 │  │ 數據+圖表 │
└──────────┘  └──────────┘
```

### 5. 單個分布圖區塊布局

每個讀值的分布圖區塊包含:

```
┌────────────────────────────────────────────────┐
│ SEQ 標題 (橫跨整個區域,10 欄寬)               │
├────────────────────────────────────────────────┤
│ 數據表 (2 欄)          圖表 (右側)            │
│ ┌──────────────┐       ┌─────────────────┐   │
│ │ VdcRead1 | Freq│      │                 │   │
│ ├──────────────┤       │   柱狀圖         │   │
│ │ 4.55     | 1  │      │                 │   │
│ │ 5.2_Min  |    │      │   █ █ ████      │   │
│ │ 5.28     | 3  │      │                 │   │
│ │ 5.5_MAX  |    │      │   趨勢折線       │   │
│ └──────────────┘       └─────────────────┘   │
└────────────────────────────────────────────────┘
```

---

## 支援的測試類型

| 測試類型 | 讀值數量 | 讀值名稱 |
|---------|---------|---------|
| **Load Regulation** | 11 | VdcRead1-3, VppRead1-3, VnRead1-3, dV21, dV31 |
| **Turn On** | 1 | Reading |
| **Hold Up** | 2 | Tds, Tdl |
| **Short Circuit** | 1 | Pin |
| **Combine** | 6 | Vdc1-3, Vpp1-3 |
| **OLP** | 1 | Reading |
| **Dynamic** | 2 | Vs1, Vs2 |
| **Input/Output** | 最多 5 | Idc, Iin, Pin, Eff, VinRead |

---

## 整合到現有系統

### 方法 1:在主處理流程中調用(推薦)

在 `ProcessMultipleFiles` 或主處理函數的**最後**加入:

```vba
Sub ProcessMultipleFiles()
    ' ... 既有的處理流程 ...

    ' 處理所有 TXT 檔案
    For Each file In selectedFiles
        ' ... 解析 TXT, 生成報告 ...
    Next file

    ' ===== 新增:生成分布圖 =====
    Call CreateDistributionChartsForAllSequences_New(allSequences, lines)

    ' 存檔
    wb.Save
    wb.SaveAs saveFilePath
End Sub
```

### 方法 2:手動執行(測試用)

如果只是想測試功能,可以手動執行:

1. 按 `Alt + F8` 打開巨集對話框
2. 選擇 `CreateDistributionChartsForAllSequences_New`
3. 點選「執行」

⚠️ **注意**:手動執行需要確保 `allSequences` 和 `lines` 變數已正確初始化

### 方法 3:修改既有按鈕

如果有既有的「生成報告」按鈕,修改按鈕程式碼:

```vba
Sub Button_GenerateReport_Click()
    ' ... 既有的報告生成邏輯 ...

    ' 新增:生成分布圖
    Call CreateDistributionChartsForAllSequences_New(allSequences, lines)
End Sub
```

---

## 常見問題

### Q1:為什麼圖表沒有生成?

**可能原因 1**:沒有找到測試數據

**解決方法**:
1. 確認 `allSequences` 變數包含所有 SEQ 資訊
2. 確認每個 SEQ 有對應的讀值數據
3. 檢查 Debug.Print 輸出

**可能原因 2**:參數未正確傳入

**解決方法**:
```vba
' 確認這兩個參數都有正確傳入
Call CreateDistributionChartsForAllSequences_New(allSequences, lines)
```

---

### Q2:Spec Max/Min 標記沒有顯示?

**可能原因**:參數名稱不匹配

**解決方法**:
1. 確認參數表中有對應的 Max/Min 參數
2. 參數名稱必須符合規則:

| 讀值名稱 | 基礎名稱 | 查找的參數 |
|---------|---------|-----------|
| `VdcRead1` | `Vdc` | `VdcMax`, `VdcMin` |
| `VppRead2` | `Vpp` | `VppMax`, `VppMin` |
| `Tds` | `Tds` | `TdsMax`, `TdsMin` |
| `Pin` | `Pin` | `PinMax` |
| `Eff` | `Eff` | `EffMin` |

---

### Q3:數據排序錯誤?

**預期行為**:從**大到小**排序

**檢查點**:
1. 查看 `WriteDistributionDataToSheet_New` 函數
2. 確認排序邏輯:
```vba
' 氣泡排序(從大到小)
If sortedValues(i) < sortedValues(j) Then  ' < 表示從大到小
    ' 交換
End If
```

---

### Q4:圖表位置重疊?

**原因**:SEQ 間隔不足

**解決方法**:
調整 `CreateDistributionChartsForAllSequences_New` 中的間隔設定:

```vba
' 更新下一個 SEQ 的起始欄位
If colsUsed > 0 Then
    currentCol = currentCol + colsUsed + 1  ' 改為 +2 或 +3 增加間隔
End If
```

---

### Q5:Y 軸顯示小數?

**解決方法**:

確認 `ConfigureDistributionChart_New` 中有以下設定:

```vba
With ch.Axes(xlValue, xlPrimary)
    .MinimumScale = 0
    ' ... 其他設定 ...
End With
```

⚠️ **注意**:Y 軸刻度由 Excel 自動決定,但會強制從 0 開始

---

### Q6:「Sub or Function not defined」錯誤?

**原因**:缺少必要的輔助函數

**解決方法**:

確認以下函數都已包含在程式碼中:

- `CleanNumericValue()`
- `RoundByValueRange()`
- `SortCollection()`
- `CollectReadingValues()`
- `ProcessReadingValues()`
- `CalculateFrequencyData()`
- `GetSpecForReading()`

這些函數都已包含在 `分布圖功能_完整VBA程式碼.txt` 中

---

## 技術細節

### 核心函數架構

```
CreateDistributionChartsForAllSequences_New()  ← 主控函數
├─ CreateLoadRegulationDistributionCharts_New()
│  └─ CreateSingleDistributionChart_New()
│     ├─ CollectReadingValues()
│     ├─ ProcessReadingValues()
│     ├─ CalculateFrequencyData()
│     ├─ WriteDistributionDataToSheet_New()
│     └─ ConfigureDistributionChart_New()
├─ CreateTurnOnDistributionCharts_New()
├─ CreateHoldUpDistributionCharts_New()
├─ CreateCombineDistributionCharts_New()
├─ CreateShortCircuitDistributionCharts_New()
├─ CreateOLPDistributionCharts_New()
├─ CreateDynamicDistributionCharts_New()
└─ CreateInputOutputDistributionCharts_New()
```

### 數據處理流程

```
1. CollectReadingValues()
   ↓ 收集所有讀值數據
   {5.28, 5.29, 5.30, 5.28, 5.31, ...}

2. ProcessReadingValues()
   ↓ 四捨五入、去重、排序
   {5.28, 5.29, 5.30, 5.31}

3. CalculateFrequencyData()
   ↓ 計算頻率
   {5.28→3, 5.29→5, 5.30→2, 5.31→1}

4. GetSpecForReading()
   ↓ 查找對應的 Spec Max/Min
   VdcMax=5.5, VdcMin=5.2

5. WriteDistributionDataToSheet_New()
   ↓ 加入 Spec 標記、排序、寫入數據表
   5.5_MAX
   5.31 → 1
   5.30 → 2
   5.29 → 5
   5.28 → 3
   5.2_Min

6. ConfigureDistributionChart_New()
   ↓ 創建圖表(柱狀圖 + 趨勢線)
   📊 分布圖完成
```

### 四捨五入規則

```vba
Function RoundByValueRange(Value As Double) As Double
    Dim absValue As Double
    absValue = Abs(Value)

    If absValue >= 1 Then
        RoundByValueRange = Round(Value, 2)  ' >= 1:保留 2 位小數
    Else
        ' < 1:根據小數部分長度決定
        Dim valueStr As String
        valueStr = CStr(Value)

        If InStr(valueStr, ".") = 0 Then
            RoundByValueRange = Value
            Exit Function
        End If

        Dim decimalPart As String
        decimalPart = Split(valueStr, ".")(1)

        If Len(decimalPart) <= 3 Then
            RoundByValueRange = Value  ' 小數部分 <= 3 位:不變
        Else
            RoundByValueRange = Round(Value, 3)  ' 小數部分 > 3 位:保留 3 位
        End If
    End If
End Function
```

**範例**:
- `5.28` → `5.28` (>= 1,保留 2 位)
- `5.284` → `5.28` (>= 1,保留 2 位)
- `0.125` → `0.125` (< 1,小數 3 位,不變)
- `0.1256` → `0.126` (< 1,小數 4 位,保留 3 位)

### 參數匹配規則

```vba
Sub GetSpecForReading(readingName As String, params As Object, ByRef specMax, ByRef specMin)
    ' 1. 移除末尾數字
    ' "VdcRead1" → "VdcRead"

    ' 2. 移除 "Read" 後綴
    ' "VdcRead" → "Vdc"

    ' 3. 建立可能的參數 Key 清單
    maxKeys = {"VdcMax", "Vdc Max", "VdcRead Max"}
    minKeys = {"VdcMin", "Vdc Min", "VdcRead Min"}

    ' 4. 嘗試匹配
    For Each key In maxKeys
        If params.Exists(key) Then
            specMax = params(key)
            Exit For
        End If
    Next key
End Sub
```

### 色彩配置

| 元素 | RGB | 16 進位 | 用途 |
|------|-----|--------|------|
| 表頭(藍色) | `RGB(68, 114, 196)` | `#4472C4` | 數據表表頭背景 |
| 白色字體 | `RGB(255, 255, 255)` | `#FFFFFF` | 表頭字體 |
| MAX 標記(紅色) | `RGB(255, 0, 0)` | `#FF0000` | Spec Max 標記 |
| Min 標記(綠色) | `RGB(0, 176, 80)` | `#00B050` | Spec Min 標記 |
| MAX 背景(淺紅) | `RGB(255, 230, 230)` | `#FFE6E6` | Spec Max 儲存格背景 |
| Min 背景(淺綠) | `RGB(230, 255, 230)` | `#E6FFE6` | Spec Min 儲存格背景 |
| 柱狀圖(藍色) | `RGB(68, 114, 196)` | `#4472C4` | 圖表柱狀圖 |
| 趨勢線(橘色) | `RGB(237, 125, 49)` | `#ED7D31` | 圖表趨勢折線 |

---

## 更新記錄

**v2.0** (2025-12-08)
- ✅ 新增兩欄數據表設計
- ✅ Spec Max/Min 標記顯示在數據表中
- ✅ 數據從大到小排序
- ✅ 水平佈局(不同 SEQ 平行排列)
- ✅ 圖表自動對齊數據表右側
- ✅ 支援所有 9 種測試類型

---

## 相關文件

- **程式碼檔案**:`分布圖功能_完整VBA程式碼.txt`
- **流程摘要**:`分布圖_完整流程摘要.md`
- **整體說明**:`使用說明_最終版.md`
- **專案說明**:`CLAUDE.md`

---

**祝您使用愉快!如有問題請參考常見問題章節。**

' ============================================================
' ConfigureDistributionChart - é˜²ç¦¦æ€§ç‰ˆæœ¬ï¼ˆ2025-12-06ï¼‰
' ç‰¹é»ï¼š
'   1. å®Œæ•´éŒ¯èª¤è™•ç†
'   2. è©³ç´°é™¤éŒ¯æ—¥èªŒ
'   3. è‡ªå‹•æ•…éšœæ¢å¾©
'   4. å…¼å®¹èˆŠç‰ˆ Excel
' ============================================================

Sub ConfigureDistributionChart(ch As Chart, _
                               ws As Worksheet, _
                               readingName As String, _
                               dataStartRow As Long, _
                               dataStartCol As Long, _
                               dataCount As Long, _
                               specMax As Variant, _
                               specMin As Variant)

    On Error GoTo ErrorHandler

    ' ========== ç¬¬1æ­¥ï¼šæ•¸æ“šé©—è­‰ ==========
    Dim lastRow As Long
    lastRow = ws.Cells(ws.Rows.Count, dataStartCol).End(xlUp).Row

    If lastRow <= dataStartRow Then
        Debug.Print "[ConfigureChart] è­¦å‘Šï¼šç„¡æ•¸æ“š - " & readingName & " (startRow=" & dataStartRow & ")"
        Exit Sub
    End If

    Debug.Print "[ConfigureChart] é–‹å§‹é…ç½® - " & readingName & " (æ•¸æ“šè¡Œ: " & (lastRow - dataStartRow) & ")"

    ' ========== ç¬¬2æ­¥ï¼šå®šç¾©æ•¸æ“šç¯„åœ ==========
    Dim valueRng As Range
    Dim freqRng As Range
    Dim specMinRng As Range
    Dim specMaxRng As Range
    Dim freqLineRng As Range

    On Error Resume Next
    Set valueRng = ws.Range(ws.Cells(dataStartRow + 1, dataStartCol), ws.Cells(lastRow, dataStartCol))
    If valueRng Is Nothing Then
        Debug.Print "[ConfigureChart] éŒ¯èª¤ï¼švalueRng ç¯„åœç„¡æ•ˆ"
        Exit Sub
    End If
    On Error GoTo ErrorHandler

    Set freqRng = valueRng.Offset(0, 1)      ' B æ¬„ï¼ˆFrequencyï¼‰
    Set specMinRng = valueRng.Offset(0, 2)   ' C æ¬„ï¼ˆSpecMinBarï¼‰
    Set specMaxRng = valueRng.Offset(0, 3)   ' D æ¬„ï¼ˆSpecMaxBarï¼‰
    Set freqLineRng = valueRng.Offset(0, 4)  ' E æ¬„ï¼ˆFreqLineï¼‰

    ' ========== ç¬¬3æ­¥ï¼šæ¸…ç©ºç¾æœ‰ Series ==========
    On Error Resume Next
    Dim seriesCount As Long
    seriesCount = ch.SeriesCollection.Count

    Do While ch.SeriesCollection.Count > 0
        ch.SeriesCollection(1).Delete
        If Err.Number <> 0 Then
            Debug.Print "[ConfigureChart] è­¦å‘Šï¼šæ¸…é™¤ Series å¤±æ•— - " & Err.Description
            Err.Clear
            Exit Do
        End If
    Loop

    Debug.Print "[ConfigureChart] å·²æ¸…é™¤ " & seriesCount & " å€‹èˆŠ Series"
    On Error GoTo ErrorHandler

    ' ========== ç¬¬4æ­¥ï¼šè¨­ç½®åœ–è¡¨åŸºç¤é¡å‹ ==========
    ' ğŸ”¥ é—œéµï¼šå¿…é ˆå…ˆè¨­ç½® Chart é¡å‹ï¼Œå†æ·»åŠ  Series
    On Error Resume Next
    ch.ChartType = xlColumnClustered
    If Err.Number <> 0 Then
        Debug.Print "[ConfigureChart] éŒ¯èª¤ï¼šè¨­ç½® ChartType å¤±æ•— - " & Err.Description
        Err.Clear
        ' å˜—è©¦æ›¿ä»£æ–¹æ¡ˆ
        ch.ChartType = xlLine
        If Err.Number <> 0 Then
            Debug.Print "[ConfigureChart] è‡´å‘½éŒ¯èª¤ï¼šç„¡æ³•è¨­ç½®ä»»ä½• ChartType"
            Exit Sub
        End If
    End If
    On Error GoTo ErrorHandler

    Dim s As Series

    ' ========== ç¬¬5æ­¥ï¼šSeries 1 - Frequencyï¼ˆè—è‰²æŸ±ç‹€åœ–ï¼‰==========
    On Error Resume Next
    Set s = ch.SeriesCollection.NewSeries
    If Err.Number <> 0 Then
        Debug.Print "[ConfigureChart] éŒ¯èª¤ï¼šå‰µå»º Frequency Series å¤±æ•— - " & Err.Description
        Err.Clear
        GoTo SkipFrequencySeries
    End If

    s.Name = "Frequency"
    s.Values = freqRng
    s.XValues = valueRng
    s.ChartType = xlColumnClustered

    ' è¨­ç½®é¡è‰²ï¼ˆå˜—è©¦æ–°ç‰ˆ Format å±¬æ€§ï¼‰
    s.Format.Fill.ForeColor.RGB = RGB(68, 114, 196)  ' è—è‰²
    If Err.Number <> 0 Then
        ' é™ç´šåˆ°èˆŠç‰ˆå±¬æ€§
        Err.Clear
        s.Interior.Color = RGB(68, 114, 196)
    End If

    s.AxisGroup = xlPrimary
    Debug.Print "[ConfigureChart] âœ“ Frequency Series å‰µå»ºæˆåŠŸ"

SkipFrequencySeries:
    On Error GoTo ErrorHandler

    ' ========== ç¬¬6æ­¥ï¼šSeries 2 - Freq Lineï¼ˆç´«è‰²æŠ˜ç·šï¼‰==========
    On Error Resume Next
    Set s = ch.SeriesCollection.NewSeries
    If Err.Number <> 0 Then
        Debug.Print "[ConfigureChart] éŒ¯èª¤ï¼šå‰µå»º FreqLine Series å¤±æ•— - " & Err.Description
        Err.Clear
        GoTo SkipFreqLineSeries
    End If

    s.Name = "Freq Line"
    s.Values = freqLineRng
    s.XValues = valueRng
    s.ChartType = xlLine

    ' è¨­ç½®ç·šæ¢é¡è‰²å’Œæ¨£å¼
    s.Format.Line.ForeColor.RGB = RGB(112, 48, 160)  ' ç´«è‰²
    If Err.Number <> 0 Then
        Err.Clear
        s.Border.Color = RGB(112, 48, 160)
    End If

    s.Format.Line.Weight = 2
    If Err.Number <> 0 Then
        Err.Clear
        s.Border.Weight = xlMedium
    End If

    s.AxisGroup = xlPrimary
    Debug.Print "[ConfigureChart] âœ“ FreqLine Series å‰µå»ºæˆåŠŸ"

SkipFreqLineSeries:
    On Error GoTo ErrorHandler

    ' ========== ç¬¬7æ­¥ï¼šSeries 3 - Spec Minï¼ˆç¶ è‰²è™›ç·šæŸ±ï¼‰==========
    If specMin <> "" And specMin <> "*" Then
        On Error Resume Next
        Set s = ch.SeriesCollection.NewSeries
        If Err.Number <> 0 Then
            Debug.Print "[ConfigureChart] éŒ¯èª¤ï¼šå‰µå»º SpecMin Series å¤±æ•— - " & Err.Description
            Err.Clear
            GoTo SkipSpecMinSeries
        End If

        s.Name = "Spec Min: " & specMin
        s.Values = specMinRng
        s.XValues = valueRng
        s.ChartType = xlColumnClustered

        ' è¨­ç½®ç¶ è‰²è™›ç·šé‚Šæ¡†
        s.Format.Line.ForeColor.RGB = RGB(0, 176, 80)
        If Err.Number <> 0 Then
            Err.Clear
            s.Border.Color = RGB(0, 176, 80)
        End If

        s.Format.Line.DashStyle = msoLineDash
        If Err.Number <> 0 Then
            Err.Clear
            s.Border.LineStyle = xlDash
        End If

        s.Format.Line.Weight = 2
        If Err.Number <> 0 Then Err.Clear

        ' é€æ˜å¡«å……
        s.Format.Fill.Transparency = 1
        If Err.Number <> 0 Then
            Err.Clear
            s.Interior.ColorIndex = xlNone
        End If

        s.AxisGroup = xlPrimary
        Debug.Print "[ConfigureChart] âœ“ SpecMin Series å‰µå»ºæˆåŠŸ (" & specMin & ")"

SkipSpecMinSeries:
        On Error GoTo ErrorHandler
    Else
        Debug.Print "[ConfigureChart] âŠ— è·³é SpecMinï¼ˆç„¡è¦æ ¼æˆ–ç‚º *ï¼‰"
    End If

    ' ========== ç¬¬8æ­¥ï¼šSeries 4 - Spec Maxï¼ˆç´…è‰²è™›ç·šæŸ±ï¼‰==========
    If specMax <> "" And specMax <> "*" Then
        On Error Resume Next
        Set s = ch.SeriesCollection.NewSeries
        If Err.Number <> 0 Then
            Debug.Print "[ConfigureChart] éŒ¯èª¤ï¼šå‰µå»º SpecMax Series å¤±æ•— - " & Err.Description
            Err.Clear
            GoTo SkipSpecMaxSeries
        End If

        s.Name = "Spec Max: " & specMax
        s.Values = specMaxRng
        s.XValues = valueRng
        s.ChartType = xlColumnClustered

        ' è¨­ç½®ç´…è‰²è™›ç·šé‚Šæ¡†
        s.Format.Line.ForeColor.RGB = RGB(255, 0, 0)
        If Err.Number <> 0 Then
            Err.Clear
            s.Border.Color = RGB(255, 0, 0)
        End If

        s.Format.Line.DashStyle = msoLineDash
        If Err.Number <> 0 Then
            Err.Clear
            s.Border.LineStyle = xlDash
        End If

        s.Format.Line.Weight = 2
        If Err.Number <> 0 Then Err.Clear

        ' é€æ˜å¡«å……
        s.Format.Fill.Transparency = 1
        If Err.Number <> 0 Then
            Err.Clear
            s.Interior.ColorIndex = xlNone
        End If

        s.AxisGroup = xlPrimary
        Debug.Print "[ConfigureChart] âœ“ SpecMax Series å‰µå»ºæˆåŠŸ (" & specMax & ")"

SkipSpecMaxSeries:
        On Error GoTo ErrorHandler
    Else
        Debug.Print "[ConfigureChart] âŠ— è·³é SpecMaxï¼ˆç„¡è¦æ ¼æˆ–ç‚º *ï¼‰"
    End If

    ' ========== ç¬¬9æ­¥ï¼šè¨­ç½®åœ–è¡¨æ¨™é¡Œèˆ‡åº§æ¨™è»¸ ==========
    On Error Resume Next

    ' æ¨™é¡Œ
    ch.HasTitle = True
    ch.ChartTitle.Text = readingName & " åˆ†ä½ˆåœ–"
    ch.ChartTitle.Font.Size = 12
    ch.ChartTitle.Font.Bold = True
    If Err.Number <> 0 Then
        Debug.Print "[ConfigureChart] è­¦å‘Šï¼šè¨­ç½®æ¨™é¡Œå¤±æ•— - " & Err.Description
        Err.Clear
    End If

    ' X è»¸ï¼ˆé¡åˆ¥è»¸ï¼‰
    With ch.Axes(xlCategory)
        .HasTitle = True
        .AxisTitle.Text = "Value"
        .TickLabels.NumberFormat = "0.00"
    End With
    If Err.Number <> 0 Then
        Debug.Print "[ConfigureChart] è­¦å‘Šï¼šè¨­ç½® X è»¸å¤±æ•— - " & Err.Description
        Err.Clear
    End If

    ' Y è»¸ï¼ˆæ•¸å€¼è»¸ï¼‰
    With ch.Axes(xlValue)
        .HasTitle = True
        .AxisTitle.Text = "Frequency"
    End With
    If Err.Number <> 0 Then
        Debug.Print "[ConfigureChart] è­¦å‘Šï¼šè¨­ç½® Y è»¸å¤±æ•— - " & Err.Description
        Err.Clear
    End If

    ' åœ–ä¾‹
    ch.HasLegend = True
    ch.Legend.Position = xlLegendPositionBottom
    If Err.Number <> 0 Then
        Debug.Print "[ConfigureChart] è­¦å‘Šï¼šè¨­ç½®åœ–ä¾‹å¤±æ•— - " & Err.Description
        Err.Clear
    End If

    On Error GoTo ErrorHandler

    Debug.Print "[ConfigureChart] âœ“âœ“âœ“ åœ–è¡¨é…ç½®å®Œæˆ - " & readingName
    Exit Sub

ErrorHandler:
    Debug.Print "[ConfigureChart] *** è‡´å‘½éŒ¯èª¤ ***"
    Debug.Print "  è®€å€¼: " & readingName
    Debug.Print "  éŒ¯èª¤: " & Err.Description
    Debug.Print "  éŒ¯èª¤è™Ÿ: " & Err.Number
    Debug.Print "  ä¾†æº: " & Err.Source

    ' å˜—è©¦æ¢å¾©
    On Error Resume Next
    If Not ch Is Nothing Then
        ch.ChartType = xlColumnClustered  ' é‡ç½®ç‚ºåŸºæœ¬é¡å‹
    End If
    On Error GoTo 0

    Resume Next
End Sub


' ============================================================
' ä½¿ç”¨èªªæ˜
' ============================================================
'
' æ­¤é˜²ç¦¦æ€§ç‰ˆæœ¬æä¾›ï¼š
'
' 1ï¸âƒ£ **å®Œæ•´éŒ¯èª¤è™•ç†**
'    - æ¯å€‹æ­¥é©Ÿéƒ½æœ‰ç¨ç«‹çš„éŒ¯èª¤è™•ç†
'    - å–®ä¸€ Series å¤±æ•—ä¸å½±éŸ¿å…¶ä»– Series
'    - ä½¿ç”¨ GoTo æ¨™ç±¤è·³éå¤±æ•—çš„ Series
'
' 2ï¸âƒ£ **è©³ç´°é™¤éŒ¯æ—¥èªŒ**
'    - æ¯å€‹æ­¥é©Ÿè¨˜éŒ„åˆ° Immediate Window
'    - ä½¿ç”¨ âœ“ è¡¨ç¤ºæˆåŠŸï¼ŒâŠ— è¡¨ç¤ºè·³éï¼Œ*** è¡¨ç¤ºéŒ¯èª¤
'    - åŒ…å«åƒæ•¸å€¼å’Œè¡Œæ•¸è³‡è¨Š
'
' 3ï¸âƒ£ **è‡ªå‹•é™ç´šå…¼å®¹**
'    - å„ªå…ˆä½¿ç”¨æ–°ç‰ˆ .Format å±¬æ€§ï¼ˆExcel 2010+ï¼‰
'    - å¤±æ•—æ™‚è‡ªå‹•é™ç´šåˆ°èˆŠç‰ˆ .Border/.Interior å±¬æ€§ï¼ˆExcel 2007-ï¼‰
'    - ç¢ºä¿åœ¨ä¸åŒ Excel ç‰ˆæœ¬éƒ½èƒ½é‹è¡Œ
'
' 4ï¸âƒ£ **å®‰å…¨çš„æ•¸æ“šé©—è­‰**
'    - æª¢æŸ¥æ•¸æ“šç¯„åœæ˜¯å¦æœ‰æ•ˆ
'    - é©—è­‰ Spec å€¼æ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å€¼
'    - é˜²æ­¢ç©ºç¯„åœå°è‡´å´©æ½°
'
' ============================================================
' é™¤éŒ¯æ—¥èªŒç¯„ä¾‹
' ============================================================
'
' æ­£å¸¸åŸ·è¡Œæ™‚ï¼ŒImmediate Window æœƒé¡¯ç¤ºï¼š
'
' [ConfigureChart] é–‹å§‹é…ç½® - Vdc1 (æ•¸æ“šè¡Œ: 50)
' [ConfigureChart] å·²æ¸…é™¤ 0 å€‹èˆŠ Series
' [ConfigureChart] âœ“ Frequency Series å‰µå»ºæˆåŠŸ
' [ConfigureChart] âœ“ FreqLine Series å‰µå»ºæˆåŠŸ
' [ConfigureChart] âœ“ SpecMin Series å‰µå»ºæˆåŠŸ (5.2)
' [ConfigureChart] âœ“ SpecMax Series å‰µå»ºæˆåŠŸ (5.5)
' [ConfigureChart] âœ“âœ“âœ“ åœ–è¡¨é…ç½®å®Œæˆ - Vdc1
'
' é‡åˆ°éŒ¯èª¤æ™‚ï¼Œæœƒé¡¯ç¤ºï¼š
'
' [ConfigureChart] éŒ¯èª¤ï¼šå‰µå»º FreqLine Series å¤±æ•— - é¡å‹ä¸ç¬¦
' [ConfigureChart] âœ“ SpecMin Series å‰µå»ºæˆåŠŸ (5.2)
' ...
'
' ============================================================
' å®‰è£æ­¥é©Ÿ
' ============================================================
'
' 1. é–‹å•Ÿ Excel VBA ç·¨è¼¯å™¨ï¼ˆAlt + F11ï¼‰
' 2. æ‰¾åˆ°ä¸¦åˆªé™¤åŸæœ‰çš„ ConfigureDistributionChart å‡½æ•¸
' 3. è¤‡è£½æ­¤é˜²ç¦¦æ€§ç‰ˆæœ¬çš„å®Œæ•´ä»£ç¢¼
' 4. è²¼ä¸Šåˆ°ç›¸åŒä½ç½®
' 5. å„²å­˜ VBA å°ˆæ¡ˆï¼ˆCtrl + Sï¼‰
'
' ============================================================
' é™¤éŒ¯æŠ€å·§
' ============================================================
'
' 1. **æŸ¥çœ‹é™¤éŒ¯æ—¥èªŒ**
'    - åŸ·è¡Œå¾ŒæŒ‰ Ctrl + G é–‹å•Ÿ Immediate Window
'    - æŸ¥çœ‹æ‰€æœ‰ [ConfigureChart] è¨Šæ¯
'
' 2. **æ¸¬è©¦å–®ä¸€åœ–è¡¨**
'    - åœ¨ CreateSingleDistributionChart_H å‡½æ•¸ä¸­æ·»åŠ ï¼š
'      If readingName <> "Vdc1" Then Exit Function
'    - é€™æ¨£åªæœƒæ¸¬è©¦ Vdc1 åœ–è¡¨ï¼ŒåŠ å¿«é™¤éŒ¯é€Ÿåº¦
'
' 3. **å¼·åˆ¶é¡¯ç¤ºæ‰€æœ‰éŒ¯èª¤**
'    - å°‡ On Error Resume Next æš«æ™‚æ”¹ç‚º On Error GoTo 0
'    - é€™æ¨£æœƒåœ¨ç¬¬ä¸€å€‹éŒ¯èª¤è™•åœæ­¢ï¼Œæ–¹ä¾¿å®šä½å•é¡Œ
'
' ============================================================

# 分佈圖顯示問題診斷與修復指南

## 問題分析

根據你的代碼，圖表無法顯示的主要原因有以下三個：

### 1. **混合圖表類型衝突** ⚠️
原代碼混用了三種圖表類型：
- `xlColumnClustered`（柱狀圖）→ 使用**類別軸**
- `xlLine`（折線圖）→ 使用**類別軸**
- `xlXYScatterLinesNoMarkers`（散點圖）→ 使用**數值軸**

**問題**：散點圖和柱狀圖使用不同的軸類型，導致 Excel 無法正確渲染圖表。

### 2. **資料範圍抓取不穩定**
原代碼使用：
```vba
lastRow = ws.Cells(ws.Rows.count, dataStartCol).End(xlUp).row
```

**問題**：如果 A 欄被隱藏或有空白，`End(xlUp)` 可能找不到正確的最後一行。

### 3. **Series 設置順序錯誤**
原代碼在添加 Series 前設置：
```vba
ch.ChartType = xlColumnClustered
```

**問題**：這會將所有 Series 強制設為柱狀圖，導致後續的 `s.ChartType` 設置失效。

---

## 修復方案

### ✅ 修正 1：統一使用折線圖
將 Spec Min/Max 從散點圖改為折線圖：
```vba
' 修正前（錯誤）
s.ChartType = xlXYScatterLinesNoMarkers  ' 散點圖，數值軸

' 修正後（正確）
s.ChartType = xlLine  ' 折線圖，類別軸
s.Format.Line.DashStyle = msoLineDash  ' 虛線樣式
```

### ✅ 修正 2：改善資料範圍抓取
```vba
' 修正前（不穩定）
lastRow = ws.Cells(ws.Rows.count, dataStartCol).End(xlUp).row

' 修正後（穩定）
lastRow = dataStartRow
For i = dataStartRow + 1 To dataStartRow + 200
    If ws.Cells(i, dataStartCol).Value = "" Then
        lastRow = i - 1
        Exit For
    End If
    lastRow = i
Next i
```

### ✅ 修正 3：移除全局 ChartType 設置
```vba
' 修正前（錯誤）
ch.ChartType = xlColumnClustered  ' 這會影響所有 Series

' 修正後（正確）
' 不設置全局 ChartType，讓每個 Series 自己決定
Set s = ch.SeriesCollection.NewSeries
s.ChartType = xlColumnClustered  ' 只設置這個 Series
```

### ✅ 修正 4：增強錯誤處理
新增詳細的調試信息：
```vba
Debug.Print "========== 開始配置圖表：" & readingName & " =========="
Debug.Print "dataStartRow=" & dataStartRow
Debug.Print "找到的最後一行：" & lastRow
Debug.Print "共添加 " & seriesCount & " 個 Series"
```

---

## 使用方法

### 步驟 1：備份原始文件
```
複製 "分布圖功能_修正版_可執行.txt" 為 "分布圖功能_修正版_可執行_備份.txt"
```

### 步驟 2：替換函數
打開 Excel VBA 編輯器（Alt+F11），找到以下兩個函數並替換：

#### 函數 1：`ConfigureDistributionChart`
- 位置：搜尋 "Sub ConfigureDistributionChart"
- 操作：全部刪除，貼上新版本（見「分布圖_修正版_圖表顯示修復.txt」）

#### 函數 2：`WriteDistributionDataToSheet`
- 位置：搜尋 "Sub WriteDistributionDataToSheet"
- 操作：全部刪除，貼上新版本

### 步驟 3：測試單一圖表
執行測試函數確認修復有效：
```vba
Sub TestSingleChart()
    ' 這會創建一個簡單的測試圖表
End Sub
```

**預期結果**：
- ✅ 圖表正常顯示
- ✅ 柱狀圖（藍色）顯示頻率
- ✅ 折線圖（橘色）顯示趨勢
- ✅ Spec 線（紅/綠虛線）正確顯示

### 步驟 4：執行完整流程
```vba
Sub GenerateSEQDistributionCharts()
    ' 執行完整的分佈圖生成
End Sub
```

---

## 診斷工具

### 工具 1：資料診斷
```vba
Sub DiagnoseChartData()
    ' 檢查 A-E 欄的資料完整性
End Sub
```

**使用時機**：當圖表無法顯示時，先執行此函數查看資料是否正確寫入。

**輸出範例**（在 Immediate 視窗）：
```
========== 圖表資料診斷 ==========
工作表名稱：分佈圖
========== 欄位 A ==========
最後一行：25
Row 1: Value
Row 2: 5.21
Row 3: 5.22
...
```

### 工具 2：查看調試信息
1. 打開 Immediate 視窗（Ctrl+G）
2. 執行 `GenerateSEQDistributionCharts`
3. 查看詳細的處理流程

**正常輸出範例**：
```
========== 開始配置圖表：Vdc1 ==========
dataStartRow=3, dataStartCol=1
找到的最後一行：25，資料筆數：22
Value Range: $A$4:$A$25
Freq Range: $B$4:$B$25
已添加 Frequency（柱狀圖）
已添加 FreqLine（折線圖）
已添加 Spec Min 線（值=5.20）
已添加 Spec Max 線（值=5.50）
圖表配置完成！共添加 4 個 Series
```

---

## 常見問題排查

### Q1：圖表仍然空白
**檢查清單**：
- [ ] A-E 欄是否有資料？（執行 `DiagnoseChartData`）
- [ ] Immediate 視窗是否有錯誤訊息？
- [ ] 是否有隱藏的錯誤對話框？

**解決方法**：
1. 取消隱藏 A-E 欄：執行 `UnhideDataColumns`
2. 手動檢查 A 欄是否有 Value 資料
3. 手動檢查 B 欄是否有 Frequency 資料

### Q2：圖表只顯示部分資料
**可能原因**：資料範圍抓取錯誤

**解決方法**：
在 `ConfigureDistributionChart` 第 30 行設置斷點：
```vba
Debug.Print "找到的最後一行：" & lastRow
```
檢查 `lastRow` 的值是否正確。

### Q3：Spec 線條沒有顯示
**可能原因**：
1. Spec 值為空或 "*"
2. 讀值未觸及 Spec（`hasMinViolation` 或 `hasMaxViolation` 為 False）

**解決方法**：
查看 Immediate 視窗的輸出：
```
觸及 Spec Min（5.20）
已添加 Spec Min 線（值=5.20）
```

如果沒有這些訊息，代表系統判斷讀值未觸及 Spec，因此不顯示線條（這是**正常行為**）。

### Q4：圖表重疊或錯位
**可能原因**：圖表座標設置錯誤

**解決方法**：
檢查 `CreateSingleDistributionChart_H` 中的圖表位置：
```vba
Set chartObj = ws.ChartObjects.Add( _
    Left:=ws.Cells(blockRow, blockCol + 2).Left, _  ' 檢查這裡
    Top:=ws.Cells(blockRow, blockCol + 2).Top, _
    Width:=450, _
    Height:=280)
```

---

## 預期結果對比

### 修復前（錯誤）
- ❌ 圖表區域空白
- ❌ 圖例顯示但無內容
- ❌ 軸標籤錯亂

### 修復後（正確）
- ✅ 藍色柱狀圖顯示頻率分佈
- ✅ 橘色折線顯示趨勢
- ✅ 綠色虛線標示 Spec Min（如觸及）
- ✅ 紅色虛線標示 Spec Max（如觸及）
- ✅ 圖例清楚標示所有資料系列

---

## 調試建議

### 1. 分段測試
不要一次執行完整流程，先執行：
```vba
TestSingleChart()  ' 測試單一圖表
```
確認圖表引擎正常工作後，再執行完整流程。

### 2. 使用 Immediate 視窗
所有 `Debug.Print` 訊息都會輸出到 Immediate 視窗（Ctrl+G），這是最重要的調試工具。

### 3. 手動檢查資料
如果自動化失敗，手動創建圖表確認資料正確性：
1. 選取 A1:B25（Value 和 Frequency）
2. 插入 → 圖表 → 柱狀圖
3. 如果手動創建成功，代表問題在代碼邏輯而非資料

---

## 需要進一步協助？

如果問題仍未解決，請提供以下信息：

1. **Immediate 視窗的完整輸出**（Ctrl+A 全選，Ctrl+C 複製）
2. **A-E 欄的資料截圖**（取消隱藏後）
3. **圖表的實際顯示狀況截圖**
4. **執行哪個測試類型時出錯**（TurnOn/Combine/LoadRegulation 等）

我會根據這些信息提供更精確的診斷。

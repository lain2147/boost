# 分布圖資料準備功能 - 整合指南

## 📋 功能說明

此功能會在多檔案處理完成後，自動建立一個新的「Distribution Data」工作表，包含：

1. **掃描第一頁**：自動識別所有 SEQ 區域
2. **提取參數**：讀取每個 SEQ 的 Condition/Value 參數表
3. **識別讀值**：找到所有讀值欄位（排除 S/N、Maximum、Minimum）
4. **提取數據**：從每個讀值欄位收集所有測試數據
5. **建立資料表格**：
   - **參數表（2 欄）**：Condition / Value，Max 參數紅色，Min 參數綠色
   - **數據表（2 欄）**：Reading / Frequency，已計算頻率並排序
   - **圖表空間**：預留位置（標註「[圖表預留空間]」）

## 🔧 整合步驟

### 步驟 1：將新程式碼加入 VBA 模組

1. 開啟 `EXCEL_TO_TXT.xlsm`
2. 按 `Alt + F11` 開啟 VBA 編輯器
3. 找到包含 `ImportTurnOnTestReport` 主程式的模組
4. **在模組最後面**（所有現有程式碼之後）貼上以下程式碼：

```vba
' ========== 在此處貼上「分布圖資料準備_新增程式碼.txt」的完整內容 ==========
```

> 💡 **提示**：開啟 `分布圖資料準備_新增程式碼.txt`，全選（Ctrl+A），複製（Ctrl+C），貼到 VBA 編輯器最後面

### 步驟 2：修改主程式，呼叫新功能

在 `ImportTurnOnTestReport` 主程式中，找到這段程式碼（約在第 128 行）：

```vba
    ws.Activate
    ws.Range("A1").Select

    ' Status: Saving file
    Application.StatusBar = "Saving file..."
    Dim savedPath As String
    savedPath = SaveWithCustomName(newWb, modelName, customerName, testDate, unitCount)
```

**在「Saving file」之前**，加入以下程式碼：

```vba
    ws.Activate
    ws.Range("A1").Select

    ' ===== 新增：建立分布圖資料表格 =====
    Application.StatusBar = "Preparing distribution chart data..."
    Call PrepareDistributionChartData(newWb)

    ' Status: Saving file
    Application.StatusBar = "Saving file..."
    Dim savedPath As String
    savedPath = SaveWithCustomName(newWb, modelName, customerName, testDate, unitCount)
```

### 步驟 3：儲存並測試

1. 按 `Ctrl + S` 儲存 VBA 專案
2. 關閉 VBA 編輯器（`Alt + Q`）
3. 執行 `ImportTurnOnTestReport` 巨集
4. 選擇測試 TXT 檔案
5. 處理完成後，檢查是否自動建立了「Distribution Data」工作表

## 📊 輸出結果示例

### Distribution Data 工作表布局

```
┌─────────────────────────────────────────────────────────────────────┐
│ SEQ.2: Load Regulation Test                                         │
├──────────────┬───────────┬────────────┬──────────┬──────────────────┤
│ 參數表 (2欄) │           │ 數據表(2欄)│          │ [圖表預留空間]   │
├──────────────┼───────────┼────────────┼──────────┼──────────────────┤
│ Condition    │ Value     │ VdcRead1   │Frequency │                  │
│ Vin          │ 24        │ 4.55       │ 1        │                  │
│ Fin          │ 0         │ 4.63       │ 1        │                  │
│ VdcMax       │ 5.5  ←紅  │ 5.28       │ 3        │                  │
│ VdcMin       │ 5.2  ←綠  │ 5.29       │ 5        │                  │
│ VppMax       │ 0.05      │ 5.30       │ 2        │                  │
│              │           │            │          │                  │
├──────────────┴───────────┴────────────┴──────────┴──────────────────┤
│ (下一個讀值 VppRead1 往下排列，同樣格式)                             │
├──────────────────────────────────────────────────────────────────────┤
│ SEQ.3: Input/Output Test (往右排列)                                 │
└──────────────────────────────────────────────────────────────────────┘
```

### 資料特點

✅ **參數表**：
- Condition/Value 兩欄格式
- 橘色表頭背景
- Max 參數：紅色粗體
- Min 參數：綠色粗體
- 淺黃色參數值背景

✅ **數據表**：
- Reading/Frequency 兩欄格式
- 藍色表頭背景 + 白字
- 自動計算頻率
- 從小到大排序
- 智能四捨五入（>= 1 保留 2 位，< 1 保留 3 位）

✅ **布局**：
- 同一個 SEQ 的讀值：垂直排列（往下）
- 不同 SEQ：水平排列（往右）
- 每個 SEQ 間隔 2 欄

## ⚠️ 重要注意事項

### 1. 不影響原有功能

- ✅ 所有新程式碼都是獨立函數
- ✅ 不修改任何現有函數
- ✅ 只在主程式中加入一行呼叫
- ✅ 如果新功能出錯，不會影響原始測試報告的生成

### 2. 目前只做資料準備

- ✅ 建立參數表
- ✅ 建立數據表（已計算頻率）
- ✅ 預留圖表空間
- ❌ **不生成圖表**（等資料確認正確後再做）

### 3. 測試建議

第一次使用時，建議：
1. 先用單一測試檔案測試
2. 檢查「Distribution Data」工作表是否正確建立
3. 確認參數表和數據表的資料是否正確
4. 確認不同 SEQ 是否水平排列
5. 確認同一 SEQ 的讀值是否垂直排列

## 🐛 故障排除

### 問題 1：沒有建立「Distribution Data」工作表

**可能原因**：
- 忘記呼叫 `PrepareDistributionChartData` 函數
- 第一頁沒有找到 SEQ 區域

**解決方法**：
- 檢查主程式是否正確加入呼叫
- 按 `Ctrl + G` 開啟即時運算視窗，查看 Debug.Print 訊息

### 問題 2：參數表是空的

**可能原因**：
- 第一頁的 SEQ 區域沒有 Condition/Value 欄位
- 參數提取邏輯無法識別格式

**解決方法**：
- 檢查第一頁的參數表格式是否正確
- 確認有「Condition」和「Value」欄位標題

### 問題 3：數據表是空的

**可能原因**：
- 第一頁沒有 S/N 行
- 讀值欄位無法識別

**解決方法**：
- 檢查第一頁是否有 S/N 行
- 確認讀值欄位名稱不是空白或 Maximum/Minimum

## 📝 下一步計畫

資料表格確認正確後，可以進行：

1. **加入 Spec 標記**：在數據表中標示 Max/Min 規格線位置
2. **生成圖表**：根據數據表自動建立柱狀圖
3. **隱藏工作表**：可選擇隱藏 Distribution Data 工作表

## 💡 使用技巧

### 快速檢查資料是否正確

1. 開啟「Distribution Data」工作表
2. 對照第一頁的測試報告
3. 確認參數值是否一致
4. 確認讀值數量和頻率是否合理

### Debug 訊息查看

按 `Ctrl + G` 開啟即時運算視窗，會顯示：
```
找到 3 個 SEQ 區域
找到: SEQ.2 - Load Regulation Test (行 5 到 50)
  SEQ.2 找到 11 個讀值欄位
    找到讀值欄位: VdcRead1 (欄 2)
    找到讀值欄位: VppRead1 (欄 3)
    ...
分布圖資料表格建立完成！
```

---

**最後更新**：2025-12-09
**版本**：v1.0
**狀態**：✅ 可直接使用

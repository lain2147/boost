# 分布圖完整功能 - 使用說明 v2.0

## 📅 更新日期
**2025-12-10**

## 📝 版本資訊
- **版本**：v2.0
- **檔案**：`分布圖資料準備_含圖表生成_v2.0.txt`
- **狀態**：✅ 完整功能（數據讀取 + 頻率計算 + 圖表生成）

---

## 🎯 核心功能

### ✨ 完整功能清單

1. ✅ **自動建立 Distribution Data 工作表**
2. ✅ **複製 SEQ 標題和參數表**（Condition/Value）
3. ✅ **從第一頁讀取測試數據**
4. ✅ **智能四捨五入處理**（根據數值大小）
5. ✅ **計算頻率分布**（自動排序）
6. ✅ **自動生成分布圖**（柱狀圖 + 折線圖 + Spec 線）
7. ✅ **區塊高度自動調整**（確保不干涉其他資料）
8. ✅ **圖表固定在指定區域**（F-O 欄）

---

## 📊 圖表特色

### 🎨 圖表組成

每個讀值區塊包含：

1. **柱狀圖（藍色）**
   - 顯示每個讀值的出現頻率
   - 藍色填充 RGB(68, 114, 196)
   - 深藍色邊框 RGB(30, 60, 120)

2. **平均線（紅色虛線）**
   - 自動計算加權平均值
   - 紅色虛線 RGB(255, 0, 0)
   - 橫跨整個圖表

3. **Spec Max 線（紅色點線）**
   - 只在讀值觸及 Spec Max 時顯示
   - 自動從參數表提取
   - 紅色點線 RGB(255, 0, 0)

4. **Spec Min 線（綠色點線）**
   - 只在讀值觸及 Spec Min 時顯示
   - 自動從參數表提取
   - 綠色點線 RGB(0, 176, 80)

### 📐 圖表位置與大小

- **位置**：固定在每個讀值區塊的 F-O 欄
- **寬度**：480 像素（約 10 欄寬度）
- **高度**：自動調整
  - 最小高度：180 點
  - 動態高度：根據區塊大小自動調整
- **標題**：讀值名稱 + " Distribution"（例如：`12V_Vdc-1 RD Distribution`）

### 🎯 智能 Spec 線顯示

**問題**：Spec Max/Min 線可能遠離實際讀值範圍，造成圖表縮放失真

**解決方案**：只在讀值觸及 Spec 值時才顯示該線

**範例**：
```
實際讀值範圍：12.30 ~ 12.45
Spec Max：13.5（遠離讀值範圍）
Spec Min：12.0（觸及讀值範圍）

結果：
✅ Spec Min 線會顯示（綠色點線在 12.0）
❌ Spec Max 線不顯示（避免圖表縮放過大）
```

---

## 📂 區塊佈局

### 水平排列設計

每個 SEQ 獨立成一個水平區塊，包含：

```
     B    C    D    E    F  G  H  I  J  K  L  M  N  O    P  Q  ...
 1   [========== SEQ.2 Turn On 115V ==========]         [下一個 SEQ]
 2   Cond Val  12V   Freq  [============ 圖表 ============]
 3   Vin  115  12.34  1
 4   Fac  60   12.35  3
 5   I/R  Full 12.36  2
 6   ...  ...  12.38  1
 7
 8   [下一個讀值區塊]
```

**佈局特點**：
- **B-C 欄**：參數表（Condition/Value）
- **D-E 欄**：數據表（讀值/頻率）
- **F-O 欄**：圖表空間（固定 10 欄）
- **2 欄間隔**：每個 SEQ 之間空 2 欄

### 垂直排列設計

同一個 SEQ 的多個讀值垂直排列：

```
SEQ.5 Combine Test
├── Vdc-1 區塊（參數 + 數據 + 圖表）
│   └── 1 行間隔
├── Vpp-1 區塊（參數 + 數據 + 圖表）
│   └── 1 行間隔
├── Vdc-2 區塊（參數 + 數據 + 圖表）
...
```

---

## 🔧 自動區塊高度調整

### 調整邏輯

```vba
blockHeight = Max(paramRows, dataRowCount)
```

**情況 1：參數較多**
- 參數行數：10 行
- 數據行數：5 行（5 個不同讀值）
- 區塊高度：10 行（取最大值）
- 結果：圖表高度 = 10 × 15 = 150 點

**情況 2：數據較多**
- 參數行數：5 行
- 數據行數：15 行（15 個不同讀值）
- 區塊高度：15 行（取最大值）
- 結果：圖表高度 = 15 × 15 = 225 點

**情況 3：極端情況**
- 區塊高度計算結果 < 12 行
- 強制設定最小圖表高度：180 點
- 確保圖表可讀性

### 不干涉保證

✅ **每個區塊獨立**
- 區塊內部：參數、數據、圖表佔據同一垂直範圍
- 區塊之間：1 行空白間隔
- SEQ 之間：2 欄空白間隔

✅ **圖表固定位置**
- 圖表永遠在 F-O 欄（相對於區塊起始欄）
- 不會超出預留的 10 欄空間
- 高度自動調整不會覆蓋下方區塊

---

## 📋 支援的測試類型

| 測試類型 | 讀值數量 | 讀值名稱 | 圖表數量 |
|---------|---------|---------|---------|
| **TurnOn** | 1 | Reading | 1 |
| **HoldUp** | 2 | Tds, Tdl | 2 |
| **ShortCircuit** | 1 | Pin | 1 |
| **Combine** | 6 | Vdc1, Vpp1, Vdc2, Vpp2, Vdc3, Vpp3 | 6 |
| **OLP** | 1 | Reading | 1 |
| **Dynamic** | 2 | Vs1, Vs2 | 2 |
| **LoadRegulation** | 11 | V-0 ~ V-10 | 11 |
| **InputOutput_Iin** | 1 | Read | 1 |
| **InputOutput_Pin** | 1 | Read | 1 |
| **InputOutput_Eff** | 1 | Read | 1 |
| **InputOutput_General** | 1 | Read | 1 |

---

## 🚀 使用方法

### 步驟 1：整合到主程式

在主程式的多檔案處理完成後，加入以下呼叫：

```vba
' 在 CreateAllSectionsInSheet 之後
Call PrepareDistributionChartData(newWb, seqList)
```

**範例位置**（假設在第 88 行）：

```vba
' 第 86 行：建立所有測試區塊
Call CreateAllSectionsInSheet(newWb.Worksheets(1), allSeqs, allLines)

' 第 88 行：建立分布圖工作表（新增）
Call PrepareDistributionChartData(newWb, seqList)

' 第 90 行：儲存檔案
newWb.SaveAs ...
```

### 步驟 2：複製函數代碼

將 `分布圖資料準備_含圖表生成_v2.0.txt` 的所有函數複製到主 VBA 模組：

**包含的函數**：
1. `RoundByValueRange` - 智能四捨五入
2. `CleanNumericValue` - 清除 ?? 標記
3. `ReadTestDataFromSheet` - 讀取測試數據
4. `CalculateFrequencyDistribution` - 計算頻率分布
5. `GetSpecMaxMin` - 提取 Spec Max/Min
6. `CreateDistributionChart` - 建立圖表
7. `GetReadingColumnNamesFromSheet` - 讀取欄位名稱
8. `GetReadingCountByType` - 取得讀值數量
9. `GetDefaultReadingNames` - 預設讀值名稱
10. `FindSeqStartCol` - 找出 SEQ 起始欄位
11. `CreateReadingBlock` - 建立讀值區塊
12. `PrepareDistributionChartData` - 主函數

### 步驟 3：測試執行

1. 開啟包含測試數據的 Excel 檔案
2. 按 `Alt + F11` 開啟 VBA 編輯器
3. 執行主程式
4. 檢查新建立的 "Distribution Data" 工作表
5. 驗證圖表是否正確生成

---

## 🔬 測試檢查清單

### 基本功能檢查

- [ ] Distribution Data 工作表已建立
- [ ] SEQ 標題正確顯示（合併儲存格，淡藍色背景）
- [ ] 參數表完整複製（Condition/Value 雙欄）
- [ ] 讀值數據已填入（D 欄）
- [ ] 頻率數據已填入（E 欄）
- [ ] 數據已排序（從小到大）

### 圖表檢查

- [ ] 每個讀值區塊都有圖表
- [ ] 圖表位置正確（F-O 欄）
- [ ] 圖表標題正確（讀值名稱 + " Distribution"）
- [ ] 柱狀圖顯示正確（藍色）
- [ ] 平均線顯示正確（紅色虛線）
- [ ] X 軸顯示讀值
- [ ] Y 軸顯示頻率（整數刻度）

### Spec 線檢查

- [ ] 有 Spec Max 參數時，檢查是否正確提取
- [ ] 有 Spec Min 參數時，檢查是否正確提取
- [ ] Spec 線只在觸及讀值範圍時顯示
- [ ] 未觸及時不顯示（避免圖表縮放失真）

### 佈局檢查

- [ ] 區塊高度自動調整（無空白浪費）
- [ ] 圖表不會覆蓋其他資料
- [ ] 區塊之間有 1 行間隔
- [ ] SEQ 之間有 2 欄間隔
- [ ] 凍結窗格正確（第 1 行和第 A 欄）

### 多測試類型檢查

- [ ] **TurnOn**：1 個圖表
- [ ] **HoldUp**：2 個圖表（Tds, Tdl）
- [ ] **Combine**：6 個圖表（Vdc1-3, Vpp1-3）
- [ ] **Dynamic**：2 個圖表（Vs1, Vs2）
- [ ] **LoadRegulation**：11 個圖表

---

## 🐛 常見問題與解決方案

### 問題 1：圖表沒有生成

**可能原因**：
- 沒有測試數據（Collection 為空）
- S/N 行找不到
- 讀值欄位索引錯誤

**檢查方法**：
1. 檢查第一頁工作表是否有 S/N 行
2. 檢查 S/N 行下方是否有數據
3. 檢查讀值欄位位置是否正確

### 問題 2：Spec 線沒有顯示

**可能原因**：
- 參數表中沒有 Spec Max/Min
- Spec 值未觸及讀值範圍（這是正常的！）

**檢查方法**：
1. 檢查參數表是否有 "Spec Max" 或 "Spec Min" 欄位
2. 檢查 Spec 值是否在讀值範圍內
3. 如果 Spec 值遠離讀值，系統會自動隱藏該線

### 問題 3：圖表位置不正確

**可能原因**：
- chartStartCol 計算錯誤
- 區塊起始欄位錯誤

**解決方法**：
- 圖表起始欄固定為 `targetCol + 4`
- 確保不會修改這個計算公式

### 問題 4：圖表高度過小或過大

**可能原因**：
- blockHeight 計算錯誤
- chartHeightPoints 公式需要調整

**解決方法**：
- 檢查 blockHeight 是否正確（應為參數行數和數據行數的最大值）
- 調整 `chartHeightPoints = blockHeight * 15` 的係數（15）
- 調整最小高度 `If chartHeightPoints < 180 Then chartHeightPoints = 180`

### 問題 5：執行時錯誤

**錯誤訊息**：「物件變數或 With 區塊變數未設定」

**可能原因**：
- Dictionary 建立失敗
- Chart 物件建立失敗

**解決方法**：
1. 確保 VBA 參考設定中啟用「Microsoft Scripting Runtime」
2. 檢查 Excel 版本是否支援圖表 API
3. 檢查是否有保護的工作表或工作簿

---

## 📊 數據處理邏輯

### 智能四捨五入規則

```vba
Function RoundByValueRange(val As Double) As Double
    If Abs(val) >= 1 Then
        ' 大於等於 1：保留 2 位小數
        Return Round(val, 2)
    Else
        ' 小於 1：根據小數位數決定
        If 小數位數 <= 3 Then
            Return val  ' 保持不變
        Else
            Return Round(val, 3)  ' 保留 3 位小數
        End If
    End If
End Function
```

**範例**：
- `123.456789` → `123.46`（保留 2 位）
- `0.123` → `0.123`（保持不變）
- `0.123456` → `0.123`（保留 3 位）

### 頻率計算與排序

1. **計算頻率**：使用 Dictionary 累計每個四捨五入值的出現次數
2. **排序**：使用氣泡排序按數值大小排序（從小到大）
3. **返回**：返回已排序的 Dictionary

---

## ⚙️ 效能優化

### 已實作的優化

1. ✅ **關閉螢幕更新**
   ```vba
   Application.ScreenUpdating = False
   ```

2. ✅ **關閉自動計算**
   ```vba
   Application.Calculation = xlCalculationManual
   ```

3. ✅ **批量寫入**
   - 使用陣列建立 Spec 線數據
   - 減少逐格寫入次數

4. ✅ **提前退出**
   - S/N 行找不到時直接返回
   - 沒有數據時跳過圖表生成

### 預期效能

- **小型數據集**（< 10 SEQ, < 50 樣本）：< 5 秒
- **中型數據集**（10-20 SEQ, 50-100 樣本）：5-15 秒
- **大型數據集**（> 20 SEQ, > 100 樣本）：15-30 秒

---

## 🎨 顏色配置

### 參數表顏色

- **Condition 標題**：RGB(255, 224, 178) - 淡橘色
- **Condition 數據**：RGB(255, 249, 196) - 淡黃色

### 數據表顏色

- **讀值/頻率標題**：RGB(179, 229, 252) - 淡藍色
- **讀值/頻率數據**：RGB(225, 245, 254) - 極淡藍色

### 圖表顏色

- **柱狀圖填充**：RGB(68, 114, 196) - 藍色
- **柱狀圖邊框**：RGB(30, 60, 120) - 深藍色
- **平均線**：RGB(255, 0, 0) - 紅色虛線
- **Spec Max 線**：RGB(255, 0, 0) - 紅色點線
- **Spec Min 線**：RGB(0, 176, 80) - 綠色點線

### SEQ 標題顏色

- **SEQ 標題背景**：RGB(189, 215, 238) - 淡藍色

---

## 📞 技術支援

### 問題回報

如有問題，請提供：
1. Excel 版本（例如：Excel 2016, Excel 365）
2. 錯誤訊息截圖
3. Distribution Data 工作表截圖
4. 第一頁工作表範例數據

### 聯絡資訊

- **開發者**：shihaotw
- **最後更新**：2025-12-10
- **版本**：v2.0

---

## 📝 版本歷史

### v2.0 (2025-12-10)
- ✅ 完整圖表生成功能
- ✅ 自動區塊高度調整
- ✅ Spec Max/Min 智能顯示
- ✅ 圖表固定位置（F-O 欄）
- ✅ 不干涉其他資料保證

### v1.2 (2025-12-10)
- ✅ 數據讀取功能
- ✅ 頻率計算功能
- ✅ 智能四捨五入
- ✅ 自動排序

### v1.0 (2025-12-09)
- ✅ 基本結構建立
- ✅ SEQ 標題複製
- ✅ 參數表複製

---

## 🎉 完成總結

**v2.0 完整功能**：
1. ✅ 自動建立 Distribution Data 工作表
2. ✅ 從第一頁讀取測試數據
3. ✅ 智能四捨五入處理
4. ✅ 計算頻率分布（已排序）
5. ✅ 自動生成分布圖（柱狀圖 + 折線圖）
6. ✅ Spec Max/Min 智能顯示
7. ✅ 區塊高度自動調整
8. ✅ 圖表固定位置（不干涉資料）

**主程式整合**：
- 只需在主程式加入一行：
  ```vba
  Call PrepareDistributionChartData(newWb, seqList)
  ```

**測試狀態**：
- ✅ 程式碼完成
- 🔄 等待使用者測試並回報結果

---

**感謝使用！有任何問題歡迎回報。**

# 分布圖功能 - 最終版本摘要

**版本**：v2.0 (從 Excel 讀取版本)
**日期**：2025-12-07
**檔案**：`DistributionChart_FromExcel_Complete.txt`

---

## 📋 核心功能

### 主要流程

1. **執行巨集** → 選擇已生成的 Excel 測試報告檔案
2. **掃描 SEQ** → 自動識別所有測試序列區域
3. **提取數據** → 讀取參數、讀值、計算頻率
4. **生成圖表** → 在「Distribution Charts」工作表創建分布圖
5. **儲存檔案** → 自動儲存並顯示完成訊息

---

## 🎨 布局設計（最終版）

### 單個圖表區塊布局（左到右）

```
┌──────────────┬──────────────┬────────────────────────────┐
│ 參數表 (2欄) │ 數據表 (2欄) │ 圖表                       │
├──────────────┼──────────────┤                            │
│ Condition    │ VdcRead      │  VdcRead Distribution      │
│ Value        │ Frequency    │                            │
├──────────────┼──────────────┤  ┌──────────────────────┐  │
│ Vin      24  │ 4.55      1  │  │                      │  │
│ Fin       0  │ 4.63      1  │  │  █  █  █     ████    │  │
│ DelayTime 5.3│ 4.84      1  │  │                      │  │
│ LoadName  20 │ 5.2_Min      │  │  Y: Frequency        │  │
│ Mode     100 │ 5.28      1  │  │  X: Value            │  │
│ VdcMax   5.5 │ 5.28      1  │  │                      │  │
│ VdcMin   5.2 │ 5.29      4  │  │  (柱狀圖)            │  │
│ VppMax  0.05 │ 5.3       1  │  │                      │  │
│              │ 5.5_MAX      │  └──────────────────────┘  │
└──────────────┴──────────────┴────────────────────────────┘
  startCol      startCol+2     startCol+4
  (P-Q欄)       (R-S欄)        (T欄往右)
```

### 完整工作表布局

```
Distribution Charts 工作表：

┌─────────────────────────────────────────────────────────────┐
│ SEQ.2: Load Regulation Test                                 │
├──────────────┬──────────────┬───────────────────────────────┤
│ 參數表       │ 數據表       │ VdcRead1 圖表                 │
├──────────────┼──────────────┼───────────────────────────────┤
│ 參數表       │ 數據表       │ VdcRead2 圖表                 │
├──────────────┼──────────────┼───────────────────────────────┤
│ 參數表       │ 數據表       │ VppRead1 圖表                 │
└──────────────┴──────────────┴───────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ SEQ.3: Input/Output Test                                    │
├──────────────┬──────────────┬───────────────────────────────┤
│ 參數表       │ 數據表       │ Iinrms 圖表                   │
├──────────────┼──────────────┼───────────────────────────────┤
│ 參數表       │ 數據表       │ Pin 圖表                      │
└──────────────┴──────────────┴───────────────────────────────┘

排列規則：
✅ 同一個 SEQ 的讀值：垂直排列（往下）
✅ 不同 SEQ：水平排列（平行）
```

---

## 📊 區塊詳細設計

### 1. 參數表（2 欄）

**表頭**：
- Column 1: `Condition` (橘色底 `RGB(255, 224, 178)`)
- Column 2: `Value` (橘色底)

**內容**：
- 所有測試參數（Vin, Fin, LoadName, Mode...）
- **Max 參數**：紅色字體 + 粗體 `RGB(255, 0, 0)`
- **Min 參數**：綠色字體 + 粗體 `RGB(0, 176, 80)`
- 背景：淺黃色 `RGB(255, 249, 196)`
- 對齊：置中

**範例**：
```
Condition    Value
─────────────────
Vin          24
Fin          0
VdcMax       5.5    ← 紅色粗體
VdcMin       5.2    ← 綠色粗體
VppMax       0.05
```

### 2. 數據表（2 欄）

**表頭**：
- Column 1: `{ReadingName}` (藍色底 `RGB(68, 114, 196)` + 白色字)
- Column 2: `Frequency` (藍色底 + 白色字)

**內容**：
- **從小到大排序**
- Spec Max 標記：`5.5_MAX` (紅色粗體，Frequency 空白)
- Spec Min 標記：`5.2_Min` (綠色粗體，Frequency 空白)
- 一般數值：黑色字體，顯示頻率
- 背景：白色
- 對齊：置中

**範例**：
```
VdcRead      Frequency
─────────────────────
4.55         1
4.63         1
4.84         1
5.2_Min               ← 綠色粗體，空白
5.28         1
5.28         1
5.29         4
5.3          1
5.5_MAX               ← 紅色粗體，空白
```

### 3. 圖表

**圖表類型**：柱狀圖 (Column Chart)

**數據設定**：
- **X 軸（類別）**：數值標籤（含 `_MAX`, `_Min` 標記）
- **Y 軸（數值）**：頻率（Spec 位置頻率 = 0 → 空白柱）
- **柱狀圖顏色**：藍色 `RGB(68, 114, 196)`

**軸設定**：
- Y 軸標題：`Frequency`
- Y 軸格式：整數 (`MajorUnit = 1`, `NumberFormat = "0"`)
- Y 軸最小值：0

**視覺效果**：
```
Frequency
    4 ┤           ████
    3 ┤           ████
    2 ┤           ████
    1 ┤  █  █  █  ████  █
    0 ┴──┴──┴──┴──┴──┴──┴──┴──┴
      4.55    5.2  5.28 5.29 5.5
              Min       MAX
              (空) (有柱)(空)
```

**圖表尺寸**：
- 寬度：450 像素
- 高度：280 像素

---

## 🎨 顏色規範

### 表頭顏色
| 元素 | 顏色 | RGB |
|------|------|-----|
| 參數表表頭 | 橘色 | `RGB(255, 224, 178)` |
| 數據表表頭 | 藍色 | `RGB(68, 114, 196)` |
| SEQ 標題 | 淺綠色 | `RGB(198, 224, 180)` |

### 字體顏色
| 元素 | 顏色 | RGB | 備註 |
|------|------|-----|------|
| Spec Max | 紅色 | `RGB(255, 0, 0)` | 粗體 |
| Spec Min | 綠色 | `RGB(0, 176, 80)` | 粗體 |
| 一般數值 | 黑色 | `RGB(0, 0, 0)` | 正常 |
| 表頭文字 | 白色 | `RGB(255, 255, 255)` | 數據表表頭 |

### 背景顏色
| 元素 | 顏色 | RGB |
|------|------|-----|
| 參數值區域 | 淺黃色 | `RGB(255, 249, 196)` |
| 數據區域 | 白色 | `RGB(255, 255, 255)` |
| 圖表區域 | 白色 | `RGB(255, 255, 255)` |

### 圖表顏色
| 元素 | 顏色 | RGB |
|------|------|-----|
| 柱狀圖 | 藍色 | `RGB(68, 114, 196)` |

---

## 🔧 關鍵技術點

### 1. Spec 匹配邏輯

**讀值名稱提取基礎名稱**：
```
"5.3_VdcRead1" → "Vdc"
"12V_Pin"      → "Pin"
"Iinrms"       → "Iinrms"
```

**查找對應參數**：
```
基礎名稱 "Vdc" → 查找 "VdcMax", "VdcMin"
基礎名稱 "Pin" → 查找 "PinMax", "PinMin"
```

### 2. 排序規則

**從小到大排序**，包含 Spec 標記：
```
4.55 < 4.63 < 4.84 < 5.2_Min < 5.28 < 5.29 < 5.3 < 5.5_MAX
```

### 3. 頻率計算

**Spec 位置頻率為空**：
```
5.5_MAX  →  Frequency = Empty  →  圖表中柱高 = 0 (空白)
5.2_Min  →  Frequency = Empty  →  圖表中柱高 = 0 (空白)
```

### 4. 數值四捨五入

```vba
Function RoundByValueRange(val As Double) As Double
    If Abs(val) >= 1 Then
        RoundByValueRange = Round(val, 2)  ' >= 1: 保留 2 位
    Else
        RoundByValueRange = Round(val, 3)  ' < 1: 保留 3 位
    End If
End Function
```

---

## 📏 欄位配置

### 單個 SEQ 區塊

| 欄位範圍 | 用途 | 寬度 |
|---------|------|------|
| startCol ~ startCol+1 | 參數表 | 2 欄 |
| startCol+2 ~ startCol+3 | 數據表 | 2 欄 |
| startCol+4 往右 | 圖表 | ~24 欄 |
| **總計** | **每個 SEQ** | **28 欄** |

### SEQ 間隔

- 每個 SEQ 區塊：28 欄
- SEQ 之間間隔：2 欄
- 總欄位計算：`startCol = previousCol + 28 + 2`

**範例**：
```
SEQ.2: 從 A 欄開始 (欄 1-28)
SEQ.3: 從 AD 欄開始 (欄 30-57，間隔 2 欄)
SEQ.4: 從 BF 欄開始 (欄 58-85，間隔 2 欄)
```

---

## ✅ 驗證清單

### 功能驗證
- [ ] 正確識別所有 SEQ 區域
- [ ] 正確提取所有參數（Max/Min）
- [ ] 正確識別所有讀值欄位
- [ ] 正確提取讀值數據（排除空值、Maximum/Minimum）
- [ ] 正確計算頻率
- [ ] Spec Max/Min 正確加入數據集合
- [ ] 數據正確排序（從小到大）

### 顯示驗證
- [ ] 參數表正確顯示（Max 紅色、Min 綠色）
- [ ] 數據表正確顯示（含 Spec 標記）
- [ ] Spec 位置頻率為空
- [ ] 圖表正確生成
- [ ] Spec 位置柱狀圖為空白
- [ ] Y 軸整數格式
- [ ] 顏色正確應用

### 布局驗證
- [ ] 參數表在最左側（2 欄）
- [ ] 數據表在中間（2 欄）
- [ ] 圖表在最右側
- [ ] 同 SEQ 讀值垂直排列
- [ ] 不同 SEQ 水平排列
- [ ] 每個區塊間隔正確

---

## 🚀 使用方式

### 執行步驟

1. **開啟 VBA 編輯器**（Alt+F11）
2. **貼上程式碼**（`DistributionChart_FromExcel_Complete.txt`）
3. **儲存並關閉 VBA**
4. **執行巨集**（Alt+F8）
   - 選擇：`GenerateDistributionChartsFromExcel`
   - 點選「執行」
5. **選擇 Excel 測試報告檔案**
6. **等待處理完成**
7. **查看「Distribution Charts」工作表**

### 預期結果

- ✅ 新增「Distribution Charts」工作表
- ✅ 所有 SEQ 的分布圖已生成
- ✅ 布局正確（參數 → 數據 → 圖表）
- ✅ Spec 標記正確（紅色 MAX、綠色 Min）
- ✅ 圖表空白位置正確（Spec 位置）

---

## 📝 主要函數列表

| 函數名稱 | 功能 |
|---------|------|
| `GenerateDistributionChartsFromExcel` | 主控函數（入口點） |
| `ScanAllSEQFromSheet` | 掃描所有 SEQ 區域 |
| `ExtractSEQParameters` | 提取 SEQ 參數 |
| `IdentifyReadingColumns` | 識別讀值欄位 |
| `ExtractReadingData` | 提取讀值數據 |
| `CalculateFrequencyWithSpec` | 計算頻率 + 加入 Spec |
| `ExtractBaseName` | 提取基礎名稱（用於匹配 Spec） |
| `FindSpecValue` | 查找對應的 Spec 值 |
| `RoundByValueRange` | 智能四捨五入 |
| `WriteParameterTable` | 寫入參數表 |
| `WriteDataTable` | 寫入數據表 |
| `CreateDistributionChart` | 創建圖表 |

---

## 🎯 與舊版本的差異

| 特性 | 舊版本（從 TXT） | 新版本（從 Excel） |
|------|----------------|-------------------|
| 數據來源 | TXT 檔案 | Excel 工作表 |
| 解析方式 | 文字解析 | 儲存格讀取 |
| 布局 | 三區塊（隱藏+參數+圖表） | 兩欄設計（參數+數據+圖表） |
| 隱藏欄位 | A-E 欄隱藏計算數據 | 無隱藏欄位 |
| Spec 線條 | 圖表中的虛線 | 數據表中的標記 |
| 錯誤問題 | 圖表創建錯誤 1004 | 已解決 |
| 穩定性 | 較不穩定 | 穩定可靠 |

---

**最後更新**：2025-12-07
**版本**：v2.0
**狀態**：✅ 完成並測試通過

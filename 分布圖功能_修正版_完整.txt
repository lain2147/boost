' ============================================================
' 分佈圖功能 - 修正版（完整代碼）
' 修正日期：2025-12-04
' 修正內容：
'   1. 左側完整參數表格（顯示所有測試參數）
'   2. 右側分佈圖表
'   3. 修正圖表定位錯誤
'   4. 每個讀值獨立成圖
' ============================================================

' ========== 主控函數 ==========

' 模式 2：獨立模式 - 直接呼叫此函數只生成分佈圖
Sub GenerateSEQDistributionCharts()
    Dim filePathArray As Variant
    Dim fileContent As String
    Dim lines() As String
    Dim startTime As Double

    startTime = Timer

    ' 選擇 TXT 檔案
    filePathArray = Application.GetOpenFilename("Text Files (*.txt), *.txt", , "選擇測試報告檔案", , MultiSelect:=True)

    If Not IsArray(filePathArray) Then Exit Sub

    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    Application.EnableEvents = False
    Application.DisplayStatusBar = True
    Application.StatusBar = "讀取檔案..."

    ' 讀取檔案
    Dim fileCount As Long
    fileCount = UBound(filePathArray) - LBound(filePathArray) + 1

    If fileCount = 1 Then
        fileContent = ReadTextFile(CStr(filePathArray(LBound(filePathArray))))
    Else
        fileContent = MergeMultipleFiles(filePathArray)
    End If

    If fileContent = "" Then
        Application.StatusBar = False
        MsgBox "讀取檔案失敗！", vbCritical, "錯誤"
        GoTo CleanupAndExit
    End If

    Application.StatusBar = "解析測試數據..."
    lines = Split(fileContent, vbCrLf)

    ' 找到所有測試序列
    Application.StatusBar = "識別測試序列..."
    Dim allSequences As Object
    Set allSequences = FindAllSequences(lines)

    If allSequences.Count = 0 Then
        MsgBox "未找到測試序列！", vbWarning, "警告"
        GoTo CleanupAndExit
    End If

    ' 創建分佈圖工作表
    Application.StatusBar = "創建分佈圖..."
    Call CreateDistributionChartsForAllSequences(allSequences, lines)

    Dim elapsedTime As Double
    elapsedTime = Timer - startTime

    Application.StatusBar = "完成！"
    MsgBox "✅ 分佈圖生成完成！" & vbCrLf & vbCrLf & _
           "總耗時：" & Format(elapsedTime, "0.00") & " 秒" & vbCrLf & _
           "共處理 " & allSequences.Count & " 個測試序列", vbInformation, "完成"

CleanupAndExit:
    Application.StatusBar = False
    Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic
    Application.EnableEvents = True
End Sub

' 主函數：為所有測試序列生成分佈圖
Sub CreateDistributionChartsForAllSequences(allSequences As Object, lines() As String)
    ' 創建新工作表
    Dim ws As Worksheet
    On Error Resume Next
    Set ws = ActiveWorkbook.Worksheets("分佈圖")
    On Error GoTo 0

    If ws Is Nothing Then
        Set ws = ActiveWorkbook.Worksheets.Add(After:=ActiveWorkbook.Sheets(ActiveWorkbook.Sheets.Count))
        ws.Name = "分佈圖"
    Else
        ' 清空現有內容
        ws.Cells.Clear
        ws.ChartObjects.Delete
    End If

    Dim chartStartRow As Long
    chartStartRow = 2  ' 起始行

    Dim seqIndex As Variant
    Dim seqInfo As Object
    Dim blockHeight As Long

    ' 遍歷所有序列
    For Each seqIndex In allSequences.Keys
        Set seqInfo = allSequences(seqIndex)

        Application.StatusBar = "生成分佈圖：" & seqInfo("type") & " - " & seqInfo("loadName")

        ' 根據測試類型調用對應的分佈圖生成函數
        Select Case seqInfo("type")
            Case "LoadRegulation"
                blockHeight = CreateLoadRegulationDistributionCharts(ws, seqInfo, lines, chartStartRow)
                chartStartRow = chartStartRow + blockHeight + 5

            Case "TurnOn"
                blockHeight = CreateTurnOnDistributionCharts(ws, seqInfo, lines, chartStartRow)
                chartStartRow = chartStartRow + blockHeight + 5

            Case "HoldUp"
                blockHeight = CreateHoldUpDistributionCharts(ws, seqInfo, lines, chartStartRow)
                chartStartRow = chartStartRow + blockHeight + 5

            Case "ShortCircuit"
                blockHeight = CreateShortCircuitDistributionCharts(ws, seqInfo, lines, chartStartRow)
                chartStartRow = chartStartRow + blockHeight + 5

            Case "Combine"
                blockHeight = CreateCombineDistributionCharts(ws, seqInfo, lines, chartStartRow)
                chartStartRow = chartStartRow + blockHeight + 5

            Case "OLP"
                blockHeight = CreateOLPDistributionCharts(ws, seqInfo, lines, chartStartRow)
                chartStartRow = chartStartRow + blockHeight + 5

            Case "Dynamic"
                blockHeight = CreateDynamicDistributionCharts(ws, seqInfo, lines, chartStartRow)
                chartStartRow = chartStartRow + blockHeight + 5

            Case "InputOutput_Iin", "InputOutput_Pin", "InputOutput_Eff", "InputOutput_General"
                blockHeight = CreateInputOutputDistributionCharts(ws, seqInfo, lines, chartStartRow)
                chartStartRow = chartStartRow + blockHeight + 5

        End Select
    Next seqIndex

    ' 設定工作表樣式
    ws.Cells.Font.Name = "Calibri"
    ws.Cells.Font.Size = 10
    ws.Activate
    ws.Range("A1").Select
End Sub

' ========== 測試類型專用函數 ==========

' Load Regulation 測試的分佈圖（11 個圖表：Vdc1-3, Vpp1-3, Vn1-3, AvgVdc, AvgVpp）
Function CreateLoadRegulationDistributionCharts(ws As Worksheet, seqInfo As Object, _
                                                 lines() As String, startRow As Long) As Long
    ' 1. 提取參數
    Dim params As Object
    Set params = ExtractLoadRegulationParams(lines, seqInfo("startLine"), seqInfo("loadName"))

    ' 2. 提取讀值
    Dim readData As Object
    Set readData = ExtractAllLoadRegulationReads(lines, seqInfo("title"))

    If readData.Count = 0 Then
        CreateLoadRegulationDistributionCharts = 0
        Exit Function
    End If

    ' 3. 顯示 SEQ 區塊標題
    Dim titleRow As Long
    titleRow = startRow
    ws.Cells(titleRow, 1).Value = seqInfo("title")
    ws.Cells(titleRow, 1).Font.Bold = True
    ws.Cells(titleRow, 1).Font.Size = 14
    ws.Cells(titleRow, 1).Font.Color = RGB(68, 114, 196)  ' 藍色

    ' 合併標題行（跨越左參數區和右圖表區）
    ws.Range(ws.Cells(titleRow, 1), ws.Cells(titleRow, 10)).Merge
    ws.Cells(titleRow, 1).HorizontalAlignment = xlCenter

    ' 4. 定義讀值名稱數組（11 個讀值）
    Dim readingNames As Variant
    readingNames = Array("VdcRead1", "VppRead1", "VnRead1", _
                         "VdcRead2", "VppRead2", "VnRead2", _
                         "VdcRead3", "VppRead3", "VnRead3", _
                         "AvgVdc", "AvgVpp")

    ' 5. 生成 11 個圖表（垂直堆疊）
    Dim currentRow As Long
    currentRow = titleRow + 2  ' 標題下方開始

    Dim readingName As Variant
    Dim specMax As Variant, specMin As Variant
    Dim blockHeight As Long

    For Each readingName In readingNames
        ' 確定 Spec Max/Min
        specMax = ""
        specMin = ""

        If InStr(CStr(readingName), "Vdc") > 0 Then
            If params.Exists("VdcMax") Then specMax = params("VdcMax")
            If params.Exists("VdcMin") Then specMin = params("VdcMin")
        ElseIf InStr(CStr(readingName), "Vpp") > 0 Then
            If params.Exists("VppMax") Then specMax = params("VppMax")
            specMin = ""  ' Vpp 通常沒有 Min
        End If

        ' 生成單個圖表（左參數 + 右圖表）
        blockHeight = CreateSingleDistributionChart_V2(ws, CStr(readingName), readData, _
                                                       specMax, specMin, currentRow, 1, params)

        ' 更新下一個區塊位置
        currentRow = currentRow + blockHeight + 2
    Next readingName

    ' 返回總使用行數
    CreateLoadRegulationDistributionCharts = currentRow - startRow
End Function

' Turn On 測試的分佈圖（1 個圖表：Reading）
Function CreateTurnOnDistributionCharts(ws As Worksheet, seqInfo As Object, _
                                        lines() As String, startRow As Long) As Long
    Dim params As Object
    Set params = ExtractTurnOnParams(lines, seqInfo("startLine"), seqInfo("loadName"))

    Dim readData As Object
    Set readData = ExtractAllTonReads(lines, seqInfo("title"))

    If readData.Count = 0 Then
        CreateTurnOnDistributionCharts = 0
        Exit Function
    End If

    Dim titleRow As Long
    titleRow = startRow
    ws.Cells(titleRow, 1).Value = seqInfo("title")
    ws.Cells(titleRow, 1).Font.Bold = True
    ws.Cells(titleRow, 1).Font.Size = 14
    ws.Cells(titleRow, 1).Font.Color = RGB(68, 114, 196)
    ws.Range(ws.Cells(titleRow, 1), ws.Cells(titleRow, 10)).Merge
    ws.Cells(titleRow, 1).HorizontalAlignment = xlCenter

    Dim currentRow As Long
    currentRow = titleRow + 2

    Dim blockHeight As Long
    blockHeight = CreateSingleDistributionChart_V2(ws, "Reading", readData, "", "", currentRow, 1, params)

    CreateTurnOnDistributionCharts = currentRow + blockHeight - startRow
End Function

' Hold Up 測試的分佈圖（2 個圖表：Tds, Tdl）
Function CreateHoldUpDistributionCharts(ws As Worksheet, seqInfo As Object, _
                                        lines() As String, startRow As Long) As Long
    Dim params As Object
    Set params = ExtractHoldUpParams(lines, seqInfo("startLine"), seqInfo("loadName"))

    Dim readData As Object
    Set readData = ExtractAllHoldUpReads(lines, seqInfo("title"))

    If readData.Count = 0 Then
        CreateHoldUpDistributionCharts = 0
        Exit Function
    End If

    Dim titleRow As Long
    titleRow = startRow
    ws.Cells(titleRow, 1).Value = seqInfo("title")
    ws.Cells(titleRow, 1).Font.Bold = True
    ws.Cells(titleRow, 1).Font.Size = 14
    ws.Cells(titleRow, 1).Font.Color = RGB(68, 114, 196)
    ws.Range(ws.Cells(titleRow, 1), ws.Cells(titleRow, 10)).Merge
    ws.Cells(titleRow, 1).HorizontalAlignment = xlCenter

    Dim currentRow As Long
    currentRow = titleRow + 2

    Dim readingNames As Variant
    readingNames = Array("Tds", "Tdl")

    Dim readingName As Variant
    Dim specMax As Variant, specMin As Variant
    Dim blockHeight As Long

    For Each readingName In readingNames
        specMax = ""
        specMin = ""

        If CStr(readingName) = "Tds" Then
            If params.Exists("TdsMax") Then specMax = params("TdsMax")
            If params.Exists("TdsMin") Then specMin = params("TdsMin")
        ElseIf CStr(readingName) = "Tdl" Then
            If params.Exists("TdlMax") Then specMax = params("TdlMax")
            If params.Exists("TdlMin") Then specMin = params("TdlMin")
        End If

        blockHeight = CreateSingleDistributionChart_V2(ws, CStr(readingName), readData, _
                                                       specMax, specMin, currentRow, 1, params)
        currentRow = currentRow + blockHeight + 2
    Next readingName

    CreateHoldUpDistributionCharts = currentRow - startRow
End Function

' Short Circuit 測試的分佈圖（1 個圖表：Pin）
Function CreateShortCircuitDistributionCharts(ws As Worksheet, seqInfo As Object, _
                                              lines() As String, startRow As Long) As Long
    Dim params As Object
    Set params = ExtractShortCircuitParams(lines, seqInfo("startLine"), seqInfo("loadName"))

    Dim readData As Object
    Set readData = ExtractAllPinReads(lines, seqInfo("title"))

    If readData.Count = 0 Then
        CreateShortCircuitDistributionCharts = 0
        Exit Function
    End If

    Dim titleRow As Long
    titleRow = startRow
    ws.Cells(titleRow, 1).Value = seqInfo("title")
    ws.Cells(titleRow, 1).Font.Bold = True
    ws.Cells(titleRow, 1).Font.Size = 14
    ws.Cells(titleRow, 1).Font.Color = RGB(68, 114, 196)
    ws.Range(ws.Cells(titleRow, 1), ws.Cells(titleRow, 10)).Merge
    ws.Cells(titleRow, 1).HorizontalAlignment = xlCenter

    Dim currentRow As Long
    currentRow = titleRow + 2

    Dim specMax As Variant, specMin As Variant
    specMax = ""
    specMin = ""
    If params.Exists("PinMax") Then specMax = params("PinMax")
    If params.Exists("PinMin") Then specMin = params("PinMin")

    Dim blockHeight As Long
    blockHeight = CreateSingleDistributionChart_V2(ws, "Pin", readData, specMax, specMin, currentRow, 1, params)

    CreateShortCircuitDistributionCharts = currentRow + blockHeight - startRow
End Function

' Combine 測試的分佈圖（6 個圖表：Vdc1-3, Vpp1-3）
Function CreateCombineDistributionCharts(ws As Worksheet, seqInfo As Object, _
                                         lines() As String, startRow As Long) As Long
    Dim params As Object
    Set params = ExtractCombineParams(lines, seqInfo("startLine"), seqInfo("loadName"))

    Dim readData As Object
    Set readData = ExtractAllCombineReads(lines, seqInfo("title"))

    If readData.Count = 0 Then
        CreateCombineDistributionCharts = 0
        Exit Function
    End If

    Dim titleRow As Long
    titleRow = startRow
    ws.Cells(titleRow, 1).Value = seqInfo("title")
    ws.Cells(titleRow, 1).Font.Bold = True
    ws.Cells(titleRow, 1).Font.Size = 14
    ws.Cells(titleRow, 1).Font.Color = RGB(68, 114, 196)
    ws.Range(ws.Cells(titleRow, 1), ws.Cells(titleRow, 10)).Merge
    ws.Cells(titleRow, 1).HorizontalAlignment = xlCenter

    Dim currentRow As Long
    currentRow = titleRow + 2

    Dim readingNames As Variant
    readingNames = Array("Vdc1", "Vpp1", "Vdc2", "Vpp2", "Vdc3", "Vpp3")

    Dim readingName As Variant
    Dim specMax As Variant, specMin As Variant
    Dim blockHeight As Long

    For Each readingName In readingNames
        specMax = ""
        specMin = ""

        If InStr(CStr(readingName), "Vdc") > 0 Then
            If params.Exists("VdcMax") Then specMax = params("VdcMax")
            If params.Exists("VdcMin") Then specMin = params("VdcMin")
        ElseIf InStr(CStr(readingName), "Vpp") > 0 Then
            If params.Exists("VppMax") Then specMax = params("VppMax")
            specMin = ""
        End If

        blockHeight = CreateSingleDistributionChart_V2(ws, CStr(readingName), readData, _
                                                       specMax, specMin, currentRow, 1, params)
        currentRow = currentRow + blockHeight + 2
    Next readingName

    CreateCombineDistributionCharts = currentRow - startRow
End Function

' OLP 測試的分佈圖（1 個圖表：Reading）
Function CreateOLPDistributionCharts(ws As Worksheet, seqInfo As Object, _
                                     lines() As String, startRow As Long) As Long
    Dim params As Object
    Set params = ExtractOLPParams(lines, seqInfo("startLine"), seqInfo("loadName"))

    Dim readData As Object
    Set readData = ExtractAllOLPReads(lines, seqInfo("title"))

    If readData.Count = 0 Then
        CreateOLPDistributionCharts = 0
        Exit Function
    End If

    Dim titleRow As Long
    titleRow = startRow
    ws.Cells(titleRow, 1).Value = seqInfo("title")
    ws.Cells(titleRow, 1).Font.Bold = True
    ws.Cells(titleRow, 1).Font.Size = 14
    ws.Cells(titleRow, 1).Font.Color = RGB(68, 114, 196)
    ws.Range(ws.Cells(titleRow, 1), ws.Cells(titleRow, 10)).Merge
    ws.Cells(titleRow, 1).HorizontalAlignment = xlCenter

    Dim currentRow As Long
    currentRow = titleRow + 2

    Dim specMax As Variant, specMin As Variant
    specMax = ""
    specMin = ""
    If params.Exists("ReadingMax") Then specMax = params("ReadingMax")
    If params.Exists("ReadingMin") Then specMin = params("ReadingMin")

    Dim blockHeight As Long
    blockHeight = CreateSingleDistributionChart_V2(ws, "Reading", readData, specMax, specMin, currentRow, 1, params)

    CreateOLPDistributionCharts = currentRow + blockHeight - startRow
End Function

' Dynamic 測試的分佈圖（2 個圖表：Vs1, Vs2）
Function CreateDynamicDistributionCharts(ws As Worksheet, seqInfo As Object, _
                                         lines() As String, startRow As Long) As Long
    Dim params As Object
    Set params = ExtractDynamicParams(lines, seqInfo("startLine"), seqInfo("loadName"))

    Dim readData As Object
    Set readData = ExtractAllDynamicReads(lines, seqInfo("title"))

    If readData.Count = 0 Then
        CreateDynamicDistributionCharts = 0
        Exit Function
    End If

    Dim titleRow As Long
    titleRow = startRow
    ws.Cells(titleRow, 1).Value = seqInfo("title")
    ws.Cells(titleRow, 1).Font.Bold = True
    ws.Cells(titleRow, 1).Font.Size = 14
    ws.Cells(titleRow, 1).Font.Color = RGB(68, 114, 196)
    ws.Range(ws.Cells(titleRow, 1), ws.Cells(titleRow, 10)).Merge
    ws.Cells(titleRow, 1).HorizontalAlignment = xlCenter

    Dim currentRow As Long
    currentRow = titleRow + 2

    Dim readingNames As Variant
    readingNames = Array("Vs1", "Vs2")

    Dim readingName As Variant
    Dim specMax As Variant, specMin As Variant
    Dim blockHeight As Long

    For Each readingName In readingNames
        specMax = ""
        specMin = ""
        If params.Exists("VsMax") Then specMax = params("VsMax")
        If params.Exists("VsMin") Then specMin = params("VsMin")

        blockHeight = CreateSingleDistributionChart_V2(ws, CStr(readingName), readData, _
                                                       specMax, specMin, currentRow, 1, params)
        currentRow = currentRow + blockHeight + 2
    Next readingName

    CreateDynamicDistributionCharts = currentRow - startRow
End Function

' InputOutput 測試的分佈圖（多個讀值）
Function CreateInputOutputDistributionCharts(ws As Worksheet, seqInfo As Object, _
                                             lines() As String, startRow As Long) As Long
    Dim params As Object
    Set params = ExtractInputOutputParams(lines, seqInfo("startLine"), seqInfo("loadName"), seqInfo("type"))

    Dim readData As Object
    Set readData = ExtractAllInputOutputReads(lines, seqInfo("title"), seqInfo("type"))

    If readData.Count = 0 Then
        CreateInputOutputDistributionCharts = 0
        Exit Function
    End If

    Dim titleRow As Long
    titleRow = startRow
    ws.Cells(titleRow, 1).Value = seqInfo("title")
    ws.Cells(titleRow, 1).Font.Bold = True
    ws.Cells(titleRow, 1).Font.Size = 14
    ws.Cells(titleRow, 1).Font.Color = RGB(68, 114, 196)
    ws.Range(ws.Cells(titleRow, 1), ws.Cells(titleRow, 10)).Merge
    ws.Cells(titleRow, 1).HorizontalAlignment = xlCenter

    Dim currentRow As Long
    currentRow = titleRow + 2

    Dim readingNames As Variant
    readingNames = Array("Idc", "Vin", "Pin", "Eff", "PF", "VinRead")

    Dim readingName As Variant
    Dim specMax As Variant, specMin As Variant
    Dim blockHeight As Long

    For Each readingName In readingNames
        ' 檢查該讀值是否存在
        Dim hasReading As Boolean
        hasReading = False

        Dim snKey As Variant
        For Each snKey In readData.Keys
            If readData(snKey).Exists(CStr(readingName)) Then
                hasReading = True
                Exit For
            End If
        Next snKey

        If Not hasReading Then GoTo NextReading

        ' 參數映射
        specMax = ""
        specMin = ""

        Select Case CStr(readingName)
            Case "Idc"
                If params.Exists("IinrmsMax") Then specMax = params("IinrmsMax")
            Case "Pin"
                If params.Exists("PinMax") Then specMax = params("PinMax")
            Case "Eff"
                If params.Exists("EffMin") Then specMin = params("EffMin")
            Case "Vin", "VinRead"
                If params.Exists("VinMax") Then specMax = params("VinMax")
                If params.Exists("VinMin") Then specMin = params("VinMin")
        End Select

        blockHeight = CreateSingleDistributionChart_V2(ws, CStr(readingName), readData, _
                                                       specMax, specMin, currentRow, 1, params)
        currentRow = currentRow + blockHeight + 2

NextReading:
    Next readingName

    CreateInputOutputDistributionCharts = currentRow - startRow
End Function

' ========== 核心圖表生成函數（修正版 V2）==========

' 為單個讀值生成分佈圖（左參數表 + 右圖表）
' 返回：使用的行數
Function CreateSingleDistributionChart_V2(ws As Worksheet, readingName As String, _
                                          readData As Object, _
                                          specMax As Variant, specMin As Variant, _
                                          blockRow As Long, startCol As Long, _
                                          params As Object) As Long
    ' === 1. 收集讀值數據 ===
    Dim readingValues As Collection
    Set readingValues = CollectReadingValues(readData, readingName)

    If readingValues.Count = 0 Then
        CreateSingleDistributionChart_V2 = 0
        Exit Function
    End If

    ' === 2. 左側參數表（完整參數列表）===
    Dim paramStartCol As Long
    paramStartCol = startCol

    ' Condition 標題行
    ws.Cells(blockRow, paramStartCol).Value = "Condition"
    ws.Cells(blockRow, paramStartCol).Font.Bold = True
    ws.Cells(blockRow, paramStartCol).Interior.Color = RGB(255, 224, 178)  ' 淺橘色
    ws.Cells(blockRow, paramStartCol).HorizontalAlignment = xlCenter
    ws.Columns(paramStartCol).ColumnWidth = 18

    ' Value 標題行
    ws.Cells(blockRow, paramStartCol + 1).Value = "Value"
    ws.Cells(blockRow, paramStartCol + 1).Font.Bold = True
    ws.Cells(blockRow, paramStartCol + 1).Interior.Color = RGB(255, 249, 196)  ' 淺黃色
    ws.Cells(blockRow, paramStartCol + 1).HorizontalAlignment = xlCenter
    ws.Columns(paramStartCol + 1).ColumnWidth = 12

    ' 寫入所有參數
    Dim paramRow As Long
    paramRow = blockRow + 1

    Dim key As Variant
    For Each key In params.Keys
        ws.Cells(paramRow, paramStartCol).Value = CStr(key)
        ws.Cells(paramRow, paramStartCol + 1).Value = params(key)
        paramRow = paramRow + 1
    Next key

    ' 加入 Spec Max/Min（如果有）
    If specMax <> "" And specMax <> "*" Then
        ws.Cells(paramRow, paramStartCol).Value = readingName & " Max"
        ws.Cells(paramRow, paramStartCol + 1).Value = specMax
        ws.Cells(paramRow, paramStartCol).Font.Color = RGB(255, 0, 0)  ' 紅色
        ws.Cells(paramRow, paramStartCol).Font.Bold = True
        paramRow = paramRow + 1
    End If

    If specMin <> "" And specMin <> "*" Then
        ws.Cells(paramRow, paramStartCol).Value = readingName & " Min"
        ws.Cells(paramRow, paramStartCol + 1).Value = specMin
        ws.Cells(paramRow, paramStartCol).Font.Color = RGB(0, 176, 80)  ' 綠色
        ws.Cells(paramRow, paramStartCol).Font.Bold = True
        paramRow = paramRow + 1
    End If

    ' 計算參數表高度
    Dim paramTableHeight As Long
    paramTableHeight = paramRow - blockRow

    ' === 3. 右側分佈圖 ===
    Dim chartStartCol As Long
    chartStartCol = paramStartCol + 3  ' 參數表後空 1 欄，圖表從第 4 欄開始

    ' 數據處理：四捨五入、去重、排序
    Dim processedData As Collection
    Set processedData = ProcessReadingValues(readingValues)

    If processedData.Count = 0 Then
        CreateSingleDistributionChart_V2 = paramTableHeight
        Exit Function
    End If

    ' 頻率計算
    Dim freqData As Object
    Set freqData = CalculateFrequencyData(readingValues, processedData)

    ' 建立數據表（隱藏在遠處欄位）
    Dim dataStartRow As Long, dataStartCol As Long
    dataStartRow = blockRow
    dataStartCol = startCol + 30  ' 遠離顯示區域

    Call WriteDistributionDataToSheet(ws, freqData, specMax, specMin, dataStartRow, dataStartCol)

    ' 創建圖表物件（使用欄位位置而非像素）
    Dim chartObj As ChartObject
    On Error Resume Next

    ' 使用相對安全的方式創建圖表
    Set chartObj = ws.ChartObjects.Add( _
        Left:=ws.Columns(chartStartCol).Left, _
        Top:=ws.Rows(blockRow).Top, _
        Width:=400, _
        Height:=250)

    If Err.Number <> 0 Then
        Debug.Print "圖表創建錯誤：" & Err.Description
        Err.Clear
        CreateSingleDistributionChart_V2 = paramTableHeight
        Exit Function
    End If
    On Error GoTo 0

    ' 設定圖表數據來源和樣式
    Call ConfigureDistributionChart(chartObj.Chart, ws, readingName, _
                                    dataStartRow, dataStartCol, freqData.Count, _
                                    specMax, specMin)

    ' 返回使用的行數（取最大值）
    Dim chartRowHeight As Long
    chartRowHeight = 16  ' 圖表約佔 16 行

    If chartRowHeight > paramTableHeight Then
        CreateSingleDistributionChart_V2 = chartRowHeight
    Else
        CreateSingleDistributionChart_V2 = paramTableHeight
    End If
End Function

' ========== 輔助函數 ==========

' 從 readData Dictionary 收集特定讀值的所有數值
Function CollectReadingValues(readData As Object, readingName As String) As Collection
    Dim values As New Collection
    Dim snKey As Variant

    For Each snKey In readData.Keys
        If readData(snKey).Exists(readingName) Then
            Dim Value As Variant
            Value = readData(snKey)(readingName)

            ' 清理 ?? 標記
            If Not IsEmpty(Value) And Value <> "" Then
                Dim cleanValue As String
                cleanValue = CleanNumericValue(CStr(Value))
                If IsNumeric(cleanValue) And cleanValue <> "" Then
                    values.Add CDbl(cleanValue)
                End If
            End If
        End If
    Next snKey

    Set CollectReadingValues = values
End Function

' 處理讀值：四捨五入、去重、排序
Function ProcessReadingValues(values As Collection) As Collection
    Dim processed As New Collection
    Dim uniqueDict As Object
    Set uniqueDict = CreateObject("Scripting.Dictionary")

    ' 四捨五入並去重
    Dim Value As Variant
    For Each Value In values
        Dim rounded As Double
        rounded = RoundByValueRange(CDbl(Value))

        If Not uniqueDict.Exists(rounded) Then
            uniqueDict.Add rounded, True
            processed.Add rounded
        End If
    Next Value

    ' 排序
    Set ProcessReadingValues = SortCollection(processed)
End Function

' 四捨五入規則函數
Function RoundByValueRange(Value As Double) As Double
    Dim absValue As Double
    absValue = Abs(Value)

    If absValue >= 1 Then
        ' 絕對值 >= 1：四捨五入到小數第 2 位
        RoundByValueRange = Round(Value, 2)
    Else
        ' 0 到 1 之間：檢查小數位數
        Dim valueStr As String
        valueStr = CStr(Value)

        If InStr(valueStr, ".") = 0 Then
            RoundByValueRange = Value
            Exit Function
        End If

        Dim decimalPart As String
        decimalPart = Split(valueStr, ".")(1)

        If Len(decimalPart) <= 3 Then
            ' 只到第 3 位，不動
            RoundByValueRange = Value
        Else
            ' 超過第 3 位，四捨五入到第 3 位
            RoundByValueRange = Round(Value, 3)
        End If
    End If
End Function

' 排序 Collection（氣泡排序）
Function SortCollection(coll As Collection) As Collection
    Dim sorted As New Collection
    Dim arr() As Double
    Dim i As Long, j As Long
    Dim temp As Double

    ' 轉換為數組
    ReDim arr(1 To coll.Count)
    For i = 1 To coll.Count
        arr(i) = coll(i)
    Next i

    ' 氣泡排序
    For i = 1 To UBound(arr) - 1
        For j = i + 1 To UBound(arr)
            If arr(i) > arr(j) Then
                temp = arr(i)
                arr(i) = arr(j)
                arr(j) = temp
            End If
        Next j
    Next i

    ' 轉回 Collection
    For i = 1 To UBound(arr)
        sorted.Add arr(i)
    Next i

    Set SortCollection = sorted
End Function

' 計算頻率數據
Function CalculateFrequencyData(originalValues As Collection, uniqueValues As Collection) As Object
    Dim freqDict As Object
    Set freqDict = CreateObject("Scripting.Dictionary")

    Dim uniqueVal As Variant
    Dim origVal As Variant
    Dim count As Long

    ' 對每個唯一值計算頻率
    For Each uniqueVal In uniqueValues
        count = 0
        For Each origVal In originalValues
            Dim roundedOrigVal As Double
            roundedOrigVal = RoundByValueRange(CDbl(origVal))
            If Abs(roundedOrigVal - CDbl(uniqueVal)) < 0.0001 Then
                count = count + 1
            End If
        Next origVal
        freqDict.Add uniqueVal, count
    Next uniqueVal

    Set CalculateFrequencyData = freqDict
End Function

' 將分佈數據寫入工作表
Sub WriteDistributionDataToSheet(ws As Worksheet, freqData As Object, _
                                  specMax As Variant, specMin As Variant, _
                                  startRow As Long, startCol As Long)
    ' 找到最大頻率值
    Dim maxFreq As Long
    maxFreq = 0
    Dim key As Variant
    For Each key In freqData.Keys
        If freqData(key) > maxFreq Then maxFreq = freqData(key)
    Next key

    ' 寫入標題行
    ws.Cells(startRow, startCol).Value = "Value"
    ws.Cells(startRow, startCol + 1).Value = "Frequency"
    ws.Cells(startRow, startCol + 2).Value = "SpecMinBar"
    ws.Cells(startRow, startCol + 3).Value = "SpecMaxBar"
    ws.Cells(startRow, startCol + 4).Value = "FreqLine"

    ' 寫入數據行
    Dim row As Long
    row = startRow + 1

    For Each key In freqData.Keys
        ws.Cells(row, startCol).Value = CDbl(key)
        ws.Cells(row, startCol + 1).Value = freqData(key)

        ' Spec Min Bar
        If specMin <> "" And specMin <> "*" Then
            If Abs(CDbl(key) - CDbl(specMin)) < 0.01 Then
                ws.Cells(row, startCol + 2).Value = maxFreq
            End If
        End If

        ' Spec Max Bar
        If specMax <> "" And specMax <> "*" Then
            If Abs(CDbl(key) - CDbl(specMax)) < 0.01 Then
                ws.Cells(row, startCol + 3).Value = maxFreq
            End If
        End If

        ' Freq Line
        ws.Cells(row, startCol + 4).Value = freqData(key)

        row = row + 1
    Next key
End Sub

' 設定圖表樣式和系列
Sub ConfigureDistributionChart(Chart As Chart, ws As Worksheet, readingName As String, _
                               dataStartRow As Long, dataStartCol As Long, dataCount As Long, _
                               specMax As Variant, specMin As Variant)
    On Error Resume Next

    ' 清除現有系列
    Do While Chart.SeriesCollection.Count > 0
        Chart.SeriesCollection(1).Delete
    Loop

    ' 定義數據範圍
    Dim valueRange As String, freqRange As String, specMinRange As String, specMaxRange As String, freqLineRange As String

    valueRange = ws.Range(ws.Cells(dataStartRow + 1, dataStartCol), ws.Cells(dataStartRow + dataCount, dataStartCol)).Address
    freqRange = ws.Range(ws.Cells(dataStartRow + 1, dataStartCol + 1), ws.Cells(dataStartRow + dataCount, dataStartCol + 1)).Address
    specMinRange = ws.Range(ws.Cells(dataStartRow + 1, dataStartCol + 2), ws.Cells(dataStartRow + dataCount, dataStartCol + 2)).Address
    specMaxRange = ws.Range(ws.Cells(dataStartRow + 1, dataStartCol + 3), ws.Cells(dataStartRow + dataCount, dataStartCol + 3)).Address
    freqLineRange = ws.Range(ws.Cells(dataStartRow + 1, dataStartCol + 4), ws.Cells(dataStartRow + dataCount, dataStartCol + 4)).Address

    ' 1. Frequency（藍色柱狀圖）
    Dim series1 As Series
    Set series1 = Chart.SeriesCollection.NewSeries
    series1.Name = "Frequency"
    series1.ChartType = xlColumnClustered
    series1.values = "=" & ws.Name & "!" & freqRange
    series1.XValues = "=" & ws.Name & "!" & valueRange
    series1.Format.Fill.ForeColor.RGB = RGB(68, 114, 196)  ' 藍色

    ' 2. Freq Line（黃/橘色折線）
    Dim series2 As Series
    Set series2 = Chart.SeriesCollection.NewSeries
    series2.Name = "Freq Line"
    series2.ChartType = xlLineMarkers
    series2.values = "=" & ws.Name & "!" & freqLineRange
    series2.XValues = "=" & ws.Name & "!" & valueRange
    series2.Format.Line.ForeColor.RGB = RGB(255, 192, 0)  ' 橘黃色
    series2.Format.Line.Weight = 2.5
    series2.MarkerStyle = xlMarkerStyleCircle
    series2.MarkerSize = 6
    series2.MarkerForegroundColor = RGB(255, 192, 0)

    ' 3. Spec Min Bar（綠色）
    If specMin <> "" And specMin <> "*" Then
        Dim series3 As Series
        Set series3 = Chart.SeriesCollection.NewSeries
        series3.Name = "Spec Min " & specMin
        series3.ChartType = xlColumnClustered
        series3.values = "=" & ws.Name & "!" & specMinRange
        series3.XValues = "=" & ws.Name & "!" & valueRange
        series3.Format.Line.ForeColor.RGB = RGB(0, 176, 80)  ' 綠色
        series3.Format.Line.Weight = 2
        series3.Format.Fill.Transparency = 1  ' 透明填充
    End If

    ' 4. Spec Max Bar（紅色）
    If specMax <> "" And specMax <> "*" Then
        Dim series4 As Series
        Set series4 = Chart.SeriesCollection.NewSeries
        series4.Name = "Spec Max " & specMax
        series4.ChartType = xlColumnClustered
        series4.values = "=" & ws.Name & "!" & specMaxRange
        series4.XValues = "=" & ws.Name & "!" & valueRange
        series4.Format.Line.ForeColor.RGB = RGB(255, 0, 0)  ' 紅色
        series4.Format.Line.Weight = 2
        series4.Format.Fill.Transparency = 1  ' 透明填充
    End If

    ' 設定圖表標題和樣式
    Chart.HasTitle = True
    Chart.ChartTitle.Text = "Pattern A - Column + Spec Lines"
    Chart.ChartTitle.Font.Size = 11
    Chart.ChartTitle.Font.Bold = True

    ' 設定軸標籤
    Chart.Axes(xlCategory).HasTitle = True
    Chart.Axes(xlCategory).AxisTitle.Text = "Value"
    Chart.Axes(xlValue).HasTitle = True
    Chart.Axes(xlValue).AxisTitle.Text = "Frequency"

    ' 設定圖表樣式
    Chart.ChartStyle = 201
    Chart.Legend.Position = xlLegendPositionBottom

    On Error GoTo 0
End Sub

# 分布圖資料讀取與頻率計算功能 - 完成記錄

## 📅 更新日期
**2025-12-10**

## 📝 版本資訊
- **版本**：v1.2
- **檔案**：`分布圖資料準備_最終版.txt`
- **狀態**：✅ 數據讀取和頻率計算功能已完成

---

## 🎯 本次實作目標

在 v1.0 基礎上（已完成 SEQ 標題和參數複製、預留 2 欄資料欄位），加入：

1. ✅ 從第一頁工作表讀取測試數據
2. ✅ 使用智能四捨五入處理數值
3. ✅ 計算頻率分布
4. ✅ 將計算結果填入 Distribution Data 工作表的預留欄位
5. ✅ 自動排序（從小到大）

---

## 🔧 新增函數清單

### 1. RoundByValueRange (行 20-53)

**功能**：智能四捨五入，根據數值大小決定保留位數

**規則**：
- **絕對值 >= 1**：保留 2 位小數
  - 例：`123.456789` → `123.46`
- **絕對值 < 1**：
  - 小數部分 <= 3 位：保持不變
    - 例：`0.123` → `0.123`
  - 小數部分 > 3 位：保留 3 位小數
    - 例：`0.123456` → `0.123`

**參數**：
- `val` (Double) - 要四捨五入的數值

**返回**：
- `Double` - 四捨五入後的值

---

### 2. CleanNumericValue (行 61-71)

**功能**：清除數值中的 `??` 標記，用於計算

**背景**：測試設備會在可疑讀值後加上 `??`（如 `123??`、`0.125??`）

**參數**：
- `val` (Variant) - 原始值（可能包含 `??`）

**返回**：
- `String` - 清除 `??` 後的字串

**範例**：
```vba
CleanNumericValue("123??")   → "123"
CleanNumericValue("0.125??") → "0.125"
CleanNumericValue("45.67")   → "45.67"
```

---

### 3. ReadTestDataFromSheet (行 75-143)

**功能**：從工作表讀取測試數據（從 S/N 行之後到 Maximum 行之前）

**參數**：
- `ws` (Worksheet) - 工作表物件
- `seqStartCol` (Long) - SEQ 起始欄位
- `readingColIndex` (Long) - 讀值欄位索引（相對於 S/N 欄，0 為第一個讀值欄）

**返回**：
- `Collection` - 包含所有有效數值的集合

**處理邏輯**：
1. 掃描 seqStartCol 欄位找出 S/N 行位置
2. 從 S/N 行下一行開始讀取數據
3. 直到遇到 Maximum、Minimum 或空行為止
4. 使用 `CleanNumericValue` 清除 `??` 標記
5. 只收集有效數值（`IsNumeric` 檢查）

**範例**：
```vba
' 讀取第一個讀值欄位（readingColIndex = 0）
Set dataCollection = ReadTestDataFromSheet(sourceWs, 2, 0)
' 返回：Collection {12.34, 12.35, 12.33, ...}
```

---

### 4. CalculateFrequencyDistribution (行 145-216)

**功能**：計算頻率分布（使用智能四捨五入並排序）

**參數**：
- `values` (Collection) - 包含所有數值的 Collection

**返回**：
- `Dictionary` - Key 為四捨五入後的值（字串），Value 為出現次數（整數）
- **已按鍵值從小到大排序**

**處理邏輯**：
1. 建立 Dictionary 儲存頻率
2. 遍歷所有數值：
   - 使用 `RoundByValueRange` 四捨五入
   - 轉成字串作為 Key（避免浮點數精度問題）
   - 累計出現次數
3. 提取所有 Key 到陣列
4. 使用氣泡排序按數值大小排序
5. 建立新的排序後 Dictionary 並返回

**範例**：
```vba
' 輸入數據：{12.341, 12.349, 12.351, 12.345}
' 四捨五入後：{12.34, 12.35, 12.35, 12.35}
' 返回 Dictionary：
'   "12.34" → 1
'   "12.35" → 3
```

---

## 🔄 修改函數清單

### 5. CreateReadingBlock (行 382-500)

**新增參數**：
- `readingColIndex` (Long) - 讀值欄位索引

**修改內容**：

#### 修改前（v1.0）：
```vba
Sub CreateReadingBlock(distWs, sourceWs, seqName, readingName, _
                      seqStartCol, paramRows, targetRow, targetCol)
    ' ...
    ' === 2. 建立數據表欄位（預留，暫不填入資料）===
    distWs.Cells(targetRow, targetCol + 2).Value = readingName
    distWs.Cells(targetRow, targetCol + 3).Value = "Frequency"
    ' 只建立標題和空白格式，不填入數據
End Sub
```

#### 修改後（v1.2）：
```vba
Sub CreateReadingBlock(distWs, sourceWs, seqName, readingName, _
                      seqStartCol, paramRows, targetRow, targetCol, _
                      readingColIndex)  ' 新增參數
    ' ...
    ' === 2. 建立數據表欄位並填入頻率分布數據 ===

    ' 讀取測試數據並計算頻率分布
    Dim testData As Collection
    Set testData = ReadTestDataFromSheet(sourceWs, seqStartCol, readingColIndex)

    Dim freqData As Object
    Set freqData = CalculateFrequencyDistribution(testData)

    ' 填入頻率分布數據
    Dim dataRow As Long
    dataRow = targetRow + 1

    For Each key In freqData.Keys
        ' 填入讀值（已四捨五入）
        distWs.Cells(dataRow, targetCol + 2).Value = CDbl(key)
        ' 填入頻率
        distWs.Cells(dataRow, targetCol + 3).Value = freqData(key)
        ' 設定格式
        dataRow = dataRow + 1
    Next key

    ' 對於剩餘的參數行，保留背景格式
    For r = dataRow To targetRow + paramRows
        ' 設定空白儲存格格式
    Next r
End Sub
```

**關鍵變更**：
- 新增 `readingColIndex` 參數，用於指定要讀取第幾個讀值欄位
- 調用 `ReadTestDataFromSheet` 讀取數據
- 調用 `CalculateFrequencyDistribution` 計算頻率
- 將結果填入預留的 2 欄（讀值 + 頻率）
- 對於剩餘的空白行也保留格式（極淡藍色背景）

---

### 6. PrepareDistributionChartData (行 502-604)

**修改位置**：呼叫 CreateReadingBlock 時加入第 9 個參數

#### 修改前（行 583-584）：
```vba
Call CreateReadingBlock(distWs, sourceWs, seqName, CStr(readingNames(i)), _
                       seqStartCol, paramRows, currentRow, currentCol)
```

#### 修改後（行 583-584）：
```vba
' i 就是該讀值的索引位置，用於從第一頁讀取對應欄位的數據
Call CreateReadingBlock(distWs, sourceWs, seqName, CStr(readingNames(i)), _
                       seqStartCol, paramRows, currentRow, currentCol, i)
```

**說明**：
- `i` 是讀值陣列的索引（0, 1, 2, ...）
- 對應到第一頁工作表 S/N 行右側的欄位順序
- 例如：Combine 測試有 6 個讀值（Vdc1, Vpp1, Vdc2, Vpp2, Vdc3, Vpp3）
  - i=0 → Vdc1（S/N 欄右側第 1 欄）
  - i=1 → Vpp1（S/N 欄右側第 2 欄）
  - i=2 → Vdc2（S/N 欄右側第 3 欄）
  - ...

---

## 📊 實作效果

### Distribution Data 工作表範例

```
     B         C         D         E         F    G    H    I    J    K
 1   [========== SEQ.2 Turn On 115V ==========]
 2   Condition Value     Reading   Frequency  [圖表空間標記...]
 3   Vin       115       12.34     1
 4   Fac       60        12.35     3
 5   I/R       Full      12.36     2
 6   LoadName  12V       12.38     1
 7   ...       ...
 8                       (空白)    (空白)
 9                       (空白)    (空白)
```

**關鍵特徵**：
- ✅ **讀值欄位**（D 欄）：顯示四捨五入後的測試數值，從小到大排序
- ✅ **頻率欄位**（E 欄）：顯示每個數值出現的次數
- ✅ **自動排序**：數值由小到大排列
- ✅ **智能四捨五入**：
  - >= 1 的值保留 2 位小數
  - < 1 的值保留 3 位小數（或更少）
- ✅ **處理異常值**：自動清除 `??` 標記

---

## 🔬 測試建議

執行主程式後，檢查以下項目：

### 基本功能（v1.0 已完成）
- [ ] Distribution Data 工作表已建立
- [ ] SEQ 標題正確顯示（合併儲存格，淡藍色背景）
- [ ] 參數表完整複製（Condition/Value 雙欄）
- [ ] 讀值區塊數量正確（依測試類型：TurnOn=1, Combine=6...）
- [ ] SEQ 之間有 2 欄間隔
- [ ] 讀值之間有 1 行間隔

### 數據計算功能（v1.2 新增）
- [ ] **讀值欄位有數據**（非空白）
- [ ] **頻率欄位有數據**（整數）
- [ ] **數值已排序**（從小到大）
- [ ] **四捨五入正確**：
  - [ ] 大於 1 的值顯示 2 位小數
  - [ ] 小於 1 的值顯示 3 位小數（或更少）
- [ ] **異常值處理正確**：帶 `??` 的數值也被計算（清除後）
- [ ] **頻率計數正確**：檢查幾個數值的頻率是否與實際一致

### 各測試類型檢查
- [ ] **TurnOn**：1 個讀值區塊有數據
- [ ] **HoldUp**：2 個讀值區塊（Tds, Tdl）都有數據
- [ ] **Combine**：6 個讀值區塊（Vdc1-3, Vpp1-3）都有數據
- [ ] **Dynamic**：2 個讀值區塊（Vs1, Vs2）都有數據
- [ ] **LoadRegulation**：11 個讀值區塊都有數據

---

## 🐛 可能的錯誤與解決方案

### 問題 1：某個讀值區塊沒有數據
**可能原因**：
- S/N 行找不到
- S/N 行下方沒有數據行
- 所有數據都是非數值（如空白、文字）

**檢查方法**：
1. 打開第一頁工作表
2. 找到對應的 SEQ 和讀值欄位
3. 檢查 S/N 行位置是否正確
4. 檢查 S/N 行下方是否有數據

### 問題 2：頻率計數錯誤
**可能原因**：
- 四捨五入規則不符預期
- 有 `??` 標記未正確清除

**檢查方法**：
1. 手動驗證幾個數值的四捨五入結果
2. 檢查原始數據是否有 `??` 標記

### 問題 3：數值沒有排序
**可能原因**：
- 氣泡排序邏輯錯誤（已完成，應該不會）

**檢查方法**：
1. 檢查 Distribution Data 中的讀值欄位是否由小到大
2. 如果沒有排序，需要檢查 `CalculateFrequencyDistribution` 函數

### 問題 4：執行時錯誤
**可能原因**：
- Dictionary 物件建立失敗
- Collection 操作錯誤

**解決方法**：
- 確保 VBA 編輯器中啟用「Microsoft Scripting Runtime」參考
- 工具 → 參考設定 → 勾選「Microsoft Scripting Runtime」

---

## 📝 下一步計畫（未來版本）

### v1.3 候選功能：加入 Spec 標記
- [ ] 讀取參數中的 Max/Min 值
- [ ] 在頻率分布數據最後加入：
  - `5.5_MAX`（紅色字體，頻率為空）
  - `5.2_Min`（綠色字體，頻率為空）

### v2.0 候選功能：生成分布圖
- [ ] 自動建立柱狀圖（頻率）
- [ ] 加入折線圖（平均線）
- [ ] 加入 Spec Max/Min 垂直線
- [ ] 設定 Y 軸格式（整數）

---

## 🎉 完成總結

**v1.2 已完成的功能**：
1. ✅ 智能四捨五入函數（RoundByValueRange）
2. ✅ 清除異常標記函數（CleanNumericValue）
3. ✅ 數據讀取函數（ReadTestDataFromSheet）
4. ✅ 頻率計算函數（CalculateFrequencyDistribution）
5. ✅ 自動填入數據到 Distribution Data 工作表
6. ✅ 自動排序（從小到大）

**主程式整合**：
- 只需要在 `72-多檔案處理加分布圖.txt` 的第 88 行加上：
  ```vba
  Call PrepareDistributionChartData(ActiveWorkbook, seqList)
  ```

**測試狀態**：
- 程式碼已完成，等待使用者測試並回報結果

---

**最後更新**：2025-12-10
**當前狀態**：✅ v1.2 實作完成，等待測試
**下一步**：使用者測試並提供回饋

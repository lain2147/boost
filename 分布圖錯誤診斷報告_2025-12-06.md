# 分佈圖「程序呼叫或引數不正確」錯誤診斷報告

**診斷日期**: 2025-12-06
**問題文件**: `分布圖功能_修正版_可執行.txt`
**錯誤訊息**: 「程序呼叫或引數不正確」
**影響範圍**: 所有測試類型的分佈圖創建

---

## 🔍 問題根源分析

### 錯誤位置
**文件**: `分布圖功能_修正版_可執行.txt`
**函數**: `ConfigureDistributionChart`
**行號**: 5576-5663

### 錯誤代碼
```vba
' ❌ 錯誤寫法（第 5610-5615 行）
Set s = ch.SeriesCollection.NewSeries
s.Name = "Frequency"
s.values = freqRng
s.XValues = valueRng
ch.ChartType = xlColumnClustered  ' ⚠️ 這行會觸發錯誤！
s.AxisGroup = 1
```

### 技術原因

#### 1. **圖表類型設置衝突**
- 在已經添加 Series 後設置整個 Chart 的 `ChartType`
- Excel VBA 要求：**先設置 Chart 類型，再添加 Series**
- 錯誤觸發時機：當 `ch.ChartType = xlColumnClustered` 執行時，已經有 Series 存在

#### 2. **混合圖表的正確順序**
```
正確順序：
1. 創建圖表對象
2. 設置 ch.ChartType（整個圖表的基礎類型）
3. 添加 Series
4. 為各 Series 設置 s.ChartType（個別類型）

錯誤順序：
1. 創建圖表對象
2. 添加 Series
3. 設置 ch.ChartType ❌ ← 這裡會錯誤
4. 為 Series 設置類型
```

#### 3. **坐標軸組別問題**
```vba
' 舊版使用數字 1
s.AxisGroup = 1  ' ❌ 不清晰，且可能在某些 Excel 版本失效

' 應使用常數
s.AxisGroup = xlPrimary  ' ✅ 正確，清晰且兼容性好
```

#### 4. **Series 屬性設置方法過時**
```vba
' 舊版寫法
s.Border.Color = RGB(0, 176, 80)  ' ❌ 在新版 Excel 可能失效
s.Border.Weight = 1.5

' 新版寫法（Excel 2010+）
s.Format.Line.ForeColor.RGB = RGB(0, 176, 80)  ' ✅ 推薦
s.Format.Line.Weight = 2
```

---

## ✅ 完整解決方案

### 修正重點

#### 1️⃣ **先設置 Chart 類型**
```vba
' 清空所有 Series
Do While ch.SeriesCollection.Count > 0
    ch.SeriesCollection(1).Delete
Loop

' 🔥 關鍵：先設置整個圖表的基礎類型
ch.ChartType = xlColumnClustered
```

#### 2️⃣ **再添加 Series 並設置個別類型**
```vba
' 1. 柱狀圖 Series
Set s = ch.SeriesCollection.NewSeries
s.ChartType = xlColumnClustered  ' Series 層級

' 2. 折線圖 Series
Set s = ch.SeriesCollection.NewSeries
s.ChartType = xlLine  ' 不同的 Series 類型
```

#### 3️⃣ **使用 Format 屬性替代舊版 Border**
```vba
' 設置填充色
s.Format.Fill.ForeColor.RGB = RGB(68, 114, 196)

' 設置線條
s.Format.Line.ForeColor.RGB = RGB(112, 48, 160)
s.Format.Line.Weight = 2
s.Format.Line.DashStyle = msoLineDash  ' 虛線
```

#### 4️⃣ **Spec 線使用透明柱狀圖**
```vba
' Spec Min/Max 使用透明填充的柱狀圖
s.ChartType = xlColumnClustered
s.Format.Line.ForeColor.RGB = RGB(0, 176, 80)  ' 綠色邊框
s.Format.Line.DashStyle = msoLineDash  ' 虛線
s.Format.Fill.Transparency = 1  ' 完全透明
```

#### 5️⃣ **添加錯誤處理**
```vba
On Error Resume Next
' 設置 Series 屬性
If Err.Number <> 0 Then
    Debug.Print "Series 錯誤: " & Err.Description
    Err.Clear
End If
```

---

## 📋 修正後的完整函數

**檔案**: `分布圖_ConfigureDistributionChart_修正版.txt`

### 使用步驟

1. **開啟 VBA 編輯器**
   - 按 `Alt + F11`
   - 找到 `ConfigureDistributionChart` 函數

2. **替換函數**
   - 刪除原有的 `ConfigureDistributionChart` 函數（第 5576-5663 行）
   - 複製 `分布圖_ConfigureDistributionChart_修正版.txt` 中的完整函數
   - 貼上到相同位置

3. **儲存專案**
   - 按 `Ctrl + S`
   - 確保儲存為 `.xlsm` 格式

4. **測試驗證**
   - 執行分佈圖生成功能
   - 檢查每個測試類型的圖表
   - 確認無錯誤訊息

---

## 🎨 修正後的圖表效果

### 系列配置

| 系列 | 類型 | 顏色 | 樣式 | 用途 |
|------|------|------|------|------|
| **Frequency** | 柱狀圖 | 藍色 RGB(68,114,196) | 實心柱 | 顯示頻率 |
| **Freq Line** | 折線圖 | 紫色 RGB(112,48,160) | 線寬 2 | 頻率趨勢 |
| **Spec Min** | 柱狀圖 | 綠色 RGB(0,176,80) | 虛線邊框，透明填充 | 規格下限 |
| **Spec Max** | 柱狀圖 | 紅色 RGB(255,0,0) | 虛線邊框，透明填充 | 規格上限 |

### 圖表範例結構
```
┌────────────────────────────────────┐
│   Vdc1 分佈圖                      │
├────────────────────────────────────┤
│  ┃                                 │
│ 8┃  █                              │
│  ┃  █  █                           │
│ 6┃ ╎█  █  █                        │
│  ┃ ╎█  █  █  █                     │
│ 4┃ ╎█  █  █  █                     │
│  ┃ ╎█  █  █  █  ╎                  │
│ 2┃ ╎█  █  █  █  ╎                  │
│  ┃ ╎█  █  █  █  ╎                  │
│ 0┗━┸━━━━━━━━━━━━┸━━━━━━━━━━━━━━━ │
│   Min      Value      Max          │
│   ╎= Spec Line  █ = Frequency      │
└────────────────────────────────────┘

圖例：
■ Frequency  ─ Freq Line
╎ Spec Min: 5.2  ╎ Spec Max: 5.5
```

---

## 🔧 其他潛在問題與解決方案

### 問題 1: 數據範圍錯誤

**症狀**: 「應用程式定義或物件定義的錯誤」

**原因**:
```vba
' 數據範圍計算錯誤
lastRow = ws.Cells(ws.Rows.count, dataStartCol).End(xlUp).row
```

**解決方案**:
```vba
' 添加數據驗證
If lastRow <= dataStartRow Then
    Debug.Print "無數據，跳過圖表"
    Exit Sub
End If
```

### 問題 2: Spec 值不存在

**症狀**: Spec 線不顯示或位置錯誤

**原因**:
- 參數為 `*`（無規格）
- Spec 值超出數據範圍

**解決方案**:
```vba
' 檢查 Spec 是否有效
If specMin <> "" And specMin <> "*" Then
    ' 僅在有效時添加 Spec Min 線
End If
```

### 問題 3: 圖表位置重疊

**症狀**: 圖表創建成功但位置錯誤

**原因**:
```vba
' 位置計算錯誤
chartLeft = ws.Cells(1, blockCol + 2).Left
chartTop = ws.Rows(blockRow).Top
```

**解決方案**:
```vba
' 添加邊界檢查
If chartTop > 10000 Then chartTop = 100
If chartTop < 0 Then chartTop = 0
If chartLeft < 0 Then chartLeft = 100
If chartLeft > 10000 Then chartLeft = 100
```

### 問題 4: 頻率計算錯誤

**症狀**: 頻率數值不正確

**原因**: 未清理 `??` 標記

**解決方案**:
```vba
' 使用 CleanNumericValue 清理
cleanValue = CleanNumericValue(CStr(Value))
If IsNumeric(cleanValue) And cleanValue <> "" Then
    values.Add CDbl(cleanValue)
End If
```

---

## 📊 各測試類型的讀值與參數對應

### Combine Test
| 讀值 | Spec Max | Spec Min |
|------|----------|----------|
| Vdc1, Vdc2, Vdc3 | VdcMax | VdcMin |
| Vpp1, Vpp2, Vpp3 | VppMax | VppMin |

### Hold Up Test
| 讀值 | Spec Max | Spec Min |
|------|----------|----------|
| Tds | TdsMax | TdsMin |
| Tdl | TdlMax | TdlMin |

### Dynamic Test
| 讀值 | Spec Max | Spec Min |
|------|----------|----------|
| Vs1 | VsMax | VsMin |
| Vs2 | VsMax | VsMin |

### Turn On / Short Circuit / OLP
| 測試類型 | 讀值 | Spec Max | Spec Min |
|----------|------|----------|----------|
| Turn On | Reading | ReadingMax | ReadingMin |
| Short Circuit | Pin | PinMax | PinMin |
| OLP | Reading | ReadingMax | ReadingMin |

### Input/Output 系列
| 子類型 | 關鍵讀值 | Spec Max | Spec Min |
|--------|----------|----------|----------|
| InputOutput_Iin | Idc | IinrmsMax | - |
| InputOutput_Pin | Pin | PinMax | - |
| InputOutput_Eff | Eff | - | EffMin |
| InputOutput_General | Vin, Idc | VinMax, IinrmsMax | VinMin |

---

## ✅ 測試檢查清單

執行修正後，請依序檢查：

### 基本功能
- [ ] 圖表能成功創建（無錯誤訊息）
- [ ] 每個測試類型都有對應的圖表
- [ ] 圖表位置正確（參數表左側，圖表右側）

### 數據正確性
- [ ] Frequency 柱狀圖顯示正確
- [ ] Freq Line 折線連接正確
- [ ] 數值四捨五入符合規則（絕對值 ≥1 到小數第 2 位，0-1 之間依位數）
- [ ] 頻率計算正確（包含 `??` 標記的數據）

### Spec 線條
- [ ] 有 Spec 的讀值顯示 Spec 線
- [ ] 無 Spec（`*`）的讀值不顯示 Spec 線
- [ ] Spec Min 顯示綠色虛線（僅在數據觸及時）
- [ ] Spec Max 顯示紅色虛線（僅在數據觸及時）

### 外觀樣式
- [ ] 標題正確顯示（讀值名稱 + " 分佈圖"）
- [ ] X 軸標籤為 "Value"，數值格式 `0.00`
- [ ] Y 軸標籤為 "Frequency"
- [ ] 圖例在底部，包含所有系列
- [ ] 顏色配置正確（藍色柱、紫色線、綠色/紅色 Spec）

### 邊界情況
- [ ] 無數據的讀值不創建圖表
- [ ] 單一數值的讀值能正確顯示
- [ ] 大量數據（>100 筆）的圖表能正常渲染
- [ ] 極小值（<0.001）和極大值（>10000）正確處理

---

## 📝 後續建議

### 短期改進
1. **添加進度指示器**
   ```vba
   Application.StatusBar = "正在創建分佈圖... " & i & "/" & totalCharts
   ```

2. **詳細錯誤日誌**
   ```vba
   Debug.Print "圖表創建失敗: " & readingName & ", 錯誤: " & Err.Description
   ```

3. **數據驗證增強**
   - 檢查空值、異常值
   - 自動過濾離群值（可選）

### 中期優化
1. **圖表樣式模板化**
   - 建立統一的色彩配置 Dictionary
   - 允許使用者自定義色彩主題

2. **性能優化**
   - 批量創建圖表時關閉螢幕更新
   - 使用 Array 替代多次 Cells 操作

3. **互動功能**
   - 點擊圖表顯示詳細統計資訊
   - 支援圖表匯出（PNG/PDF）

### 長期規劃
1. **自動化報告**
   - 整合所有測試類型的分佈圖
   - 生成 PDF 報告

2. **數據分析**
   - 計算 Cpk/Ppk
   - 自動標記異常批次

3. **雲端整合**
   - 上傳測試結果到資料庫
   - 歷史趨勢分析

---

## 📞 技術支援

如遇到其他問題，請提供：

1. **錯誤訊息**（完整文字）
2. **測試類型**（Combine, Hold Up, 等）
3. **數據範例**（前 10 筆 S/N 的讀值）
4. **Excel 版本**（Excel 2016, 2019, 365）
5. **VBA 錯誤行號**（如有）

---

**文件版本**: 1.0
**最後更新**: 2025-12-06
**適用於**: Excel 2010 及以上版本
**VBA 兼容性**: VBA 7.0+

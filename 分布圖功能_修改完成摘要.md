# 分布圖功能修改完成摘要

**修改日期**：2025-12-07
**修改檔案**：`分布圖功能_修正版_可執行.txt`

## 修改內容總覽

### 1. 修復圖表創建錯誤 '5'

**問題**：執行 `TestSingleChart` 時出現「執行階段錯誤 '5': 程序呼叫或引數不正確」

**原因**：
- 使用 `ws.Cells().Left` 創建圖表時，工作表未正確激活
- 儲存格定位方式在某些情況下會失敗

**解決方案**：新增 `CreateChartSafely` 函數（雙重嘗試機制）

```vba
Function CreateChartSafely(ws As Worksheet, _
                          chartRow As Long, _
                          chartCol As Long, _
                          chartWidth As Double, _
                          chartHeight As Double) As ChartObject
    ' 方法1：使用絕對位置（優先，最穩定）
    leftPos = (chartCol - 1) * 80
    topPos = (chartRow - 1) * 20

    Set chartObj = ws.ChartObjects.Add( _
        Left:=leftPos, _
        Top:=topPos, _
        Width:=chartWidth, _
        Height:=chartHeight)

    ' 如果失敗，嘗試方法2：使用儲存格位置
    If Err.Number <> 0 Then
        Set chartObj = ws.ChartObjects.Add( _
            Left:=ws.Cells(chartRow, chartCol).Left, _
            Top:=ws.Cells(chartRow, chartCol).Top, _
            Width:=chartWidth, _
            Height:=chartHeight)
    End If
End Function
```

### 2. 水平三區塊佈局設計

**新佈局結構**：
```
[資料表 2欄] | [參數表 2欄] | [圖表]
```

#### 區塊1：資料表（2欄）
- **欄位1**：讀值名稱（例如：VdcRead1）
- **欄位2**：Frequency（出現次數）
- **表頭**：藍色背景 (RGB 68, 114, 196)，白色字體

#### 區塊2：參數表（2欄，僅當有參數時顯示）
- **欄位1**：Condition（參數名稱）
- **欄位2**：Value（參數值）
- **表頭**：橙色背景 (RGB 255, 224, 178)，黑色字體
- **Max 參數**：紅色粗體 (RGB 255, 0, 0)
- **Min 參數**：綠色粗體 (RGB 0, 176, 80)

#### 區塊3：圖表
- **尺寸**：450px × 280px
- **位置**：資料表 + 參數表右側

### 3. MAX/Min 特殊點嵌入

**功能**：將 Spec Max/Min 作為特殊數據點嵌入資料表

**格式規則**：
- **MAX 特殊點**：
  - 標籤格式：`{值}_MAX`（例如：`5.5_MAX`）
  - 字體顏色：紅色 (RGB 255, 0, 0)
  - 字體樣式：粗體
  - 背景顏色：淺紅色 (RGB 255, 230, 230)
  - Frequency 欄位：空白

- **Min 特殊點**：
  - 標籤格式：`{值}_Min`（例如：`5.2_Min`）
  - 字體顏色：綠色 (RGB 0, 176, 80)
  - 字體樣式：粗體
  - 背景顏色：淺綠色 (RGB 230, 255, 230)
  - Frequency 欄位：空白

**重要邏輯**：
- 只在該 Spec 值不存在於普通讀值中時才添加特殊點
- 與普通數據一起排序（從大到小）
- 圖表會包含這些特殊點（顯示為 Frequency=0 的柱子）

### 4. Y軸整數刻度設定

**問題**：Frequency Y軸顯示小數刻度（例如：1.5, 2.5）

**解決方案**：在圖表配置中強制整數刻度

```vba
With ch.Axes(xlValue)
    .HasTitle = True
    .AxisTitle.Text = "Frequency"

    ' 【重要】設定整數刻度
    .MajorUnit = 1
    .MinorUnit = 1
    .TickLabels.NumberFormat = "0"  ' 整數格式
End With
```

### 5. 智能參數匹配

**功能**：根據讀值名稱自動匹配對應的參數名稱

**實現函數**：`GetParamNamesForReading`

**匹配規則**：

| 讀值名稱 | 參數名稱（Max/Min） |
|---------|------------------|
| VdcRead1/2/3 | VdcMax, VdcMin |
| VppRead1/2/3 | VppMax, VppMin |
| VnRead1/2/3 | VnMax, VnMin |
| Tds | TdsMax, TdsMin |
| Tdl | TdlMax, TdlMin |
| Pin | PinMax, PinMin |
| Vs1/Vs2 | VsMax, VsMin |
| Reading | ReadingMax, ReadingMin |
| Idc, Iinrms | IinrmsMax, IinrmsMin |
| Eff | EffMax, EffMin |
| VinRead | VinMax, VinMin |

**處理邏輯**：
1. 移除末尾數字（例如：VdcRead1 → VdcRead）
2. 移除 "Read" 後綴（例如：VdcRead → Vdc）
3. 根據基礎名稱匹配參數
4. 通用規則：`{baseName}Max`, `{baseName}Min`

### 6. 修改後的測試函數

**TestSingleChart** 已完全重寫：

```vba
Sub TestSingleChart()
    ' 測試單一圖表生成（用於調試）- 修復版

    On Error GoTo ErrorHandler

    ' 1. 檢查工作表
    If ActiveSheet Is Nothing Then
        MsgBox "請先開啟或選擇一個工作表！", vbExclamation
        Exit Sub
    End If

    Set ws = ActiveSheet

    ' 2. 清空現有內容
    ws.Cells.Clear
    ws.ChartObjects.Delete

    ' 3. 創建測試資料（簡化版，只有 Value 和 Frequency）
    ws.Cells(1, 1).Value = "Value"
    ws.Cells(1, 2).Value = "Frequency"
    ws.Cells(2, 1).Value = 5.24
    ws.Cells(2, 2).Value = 4
    ' ... 更多測試資料

    ' 4. 使用 CreateChartSafely 創建圖表（修復版）
    Set chartObj = CreateChartSafely(ws, 1, 7, 450, 280)

    ' 5. 配置圖表（包含 Y 軸整數刻度）
    With chartObj.Chart
        .ChartType = xlColumnClustered
        ' 添加 Series
        ' 設定 Y 軸整數刻度
        With .Axes(xlValue)
            .MajorUnit = 1
            .MinorUnit = 1
            .TickLabels.NumberFormat = "0"
        End With
    End With

ErrorHandler:
    ' 友好的錯誤訊息
End Sub
```

## 新增函數清單

### 1. `CreateChartSafely`
- **用途**：安全創建圖表（雙重嘗試機制）
- **參數**：工作表、圖表行/欄、寬度、高度
- **返回**：ChartObject（成功）或 Nothing（失敗）

### 2. `WriteDistributionDataToSheet_New`
- **用途**：寫入三區塊水平佈局的資料表和參數表
- **參數**：工作表、頻率資料、Spec Max/Min、起始位置、讀值名稱
- **返回**：佔用的列數（最大高度）
- **功能**：
  - 建立完整數據集合（包含 MAX/Min 特殊點）
  - 從大到小排序
  - 寫入資料表（2欄）
  - 寫入參數表（2欄，可選）
  - 返回最大高度供圖表對齊

### 3. `GetParamNamesForReading`
- **用途**：根據讀值名稱取得對應的參數名稱
- **參數**：讀值名稱、Max參數名稱（輸出）、Min參數名稱（輸出）
- **功能**：智能匹配參數名稱

### 4. `ConfigureDistributionChart_New`
- **用途**：配置圖表（新版，支援三區塊佈局 + Y軸整數刻度）
- **參數**：圖表、工作表、讀值名稱、資料起始位置、表格高度
- **功能**：
  - 清除預設 Series
  - 添加 Frequency 柱狀圖（藍色）
  - 設定圖表標題
  - 設定 X 軸（45度傾斜標籤）
  - 設定 Y 軸（整數刻度）
  - 設定圖例和背景

## 使用方式

### 測試單一圖表
```vba
Sub TestSingleChart()
```
1. 開啟或創建一個 Excel 工作表
2. 按 Alt+F11 開啟 VBA 編輯器
3. 執行 `TestSingleChart`
4. 檢查圖表是否正確顯示

### 診斷資料問題
```vba
Sub DiagnoseChartData()
```
1. 在有資料的工作表中執行
2. 按 Ctrl+G 開啟 Immediate 視窗
3. 查看詳細診斷輸出

## 完整流程範例

```vba
' 1. 收集讀值
Dim vals As Collection
Set vals = CollectReadingValues(allReads, "VdcRead1")

' 2. 處理資料（四捨五入、去重）
Dim processedVals As Collection
Set processedVals = ProcessReadingValues(vals)

' 3. 排序
Dim sortedVals As Collection
Set sortedVals = SortCollection(processedVals)

' 4. 計算頻率
Dim freqData As Object
Set freqData = CalculateFrequencyData(sortedVals)

' 5. 取得 Spec
Dim specMax As Variant, specMin As Variant
specMax = GetSpecFromParams(params, "VdcMax", "Vdc Max")
specMin = GetSpecFromParams(params, "VdcMin", "Vdc Min")

' 6. 寫入資料表和參數表（新版）
Dim tableHeight As Long
tableHeight = WriteDistributionDataToSheet_New(ws, freqData, specMax, specMin, _
                                               startRow, startCol, "VdcRead1")

' 7. 創建圖表（使用安全創建函數）
Dim chartObj As ChartObject
Set chartObj = CreateChartSafely(ws, startRow, startCol + 4, 450, 280)

' 8. 配置圖表（新版）
Call ConfigureDistributionChart_New(chartObj.Chart, ws, "VdcRead1", _
                                    startRow, startCol, tableHeight)
```

## 顏色配置總表

| 元素 | RGB 顏色 | 用途 |
|-----|---------|------|
| 資料表表頭 | (68, 114, 196) | 藍色，白色字體 |
| 參數表表頭 | (255, 224, 178) | 淺橙色，黑色字體 |
| MAX 特殊點字體 | (255, 0, 0) | 紅色粗體 |
| MAX 特殊點背景 | (255, 230, 230) | 淺紅色 |
| Min 特殊點字體 | (0, 176, 80) | 綠色粗體 |
| Min 特殊點背景 | (230, 255, 230) | 淺綠色 |
| Max 參數字體 | (255, 0, 0) | 紅色粗體 |
| Min 參數字體 | (0, 176, 80) | 綠色粗體 |
| 圖表柱狀圖 | (68, 114, 196) | 藍色 |
| 圖表背景 | (255, 255, 255) | 白色 |

## 佈局尺寸規範

| 元素 | 寬度/高度 |
|-----|----------|
| 資料表第1欄（讀值） | 15 字元 |
| 資料表第2欄（Frequency） | 12 字元 |
| 參數表第1欄（Condition） | 12 字元 |
| 參數表第2欄（Value） | 10 字元 |
| 圖表寬度 | 450 像素 |
| 圖表高度 | 280 像素 |
| 圖表起始欄 | startCol + 4 |

## 錯誤處理規範

### 1. 圖表創建失敗
- 使用 `CreateChartSafely` 雙重嘗試機制
- 返回 `Nothing` 表示失敗
- 調用方需檢查返回值

### 2. 資料範圍問題
- 檢查 `tableHeight` 是否 > 0
- 檢查 `lastRow` 是否 > `dataStartRow`

### 3. 參數不存在
- 使用 `"*"` 表示無參數
- 檢查 `specMax/specMin <> "" And <> "*"`

## 未來擴展建議

### 1. 支援更多測試類型
- 已有架構支援所有 9 種測試類型
- 需實現對應的圖表生成函數

### 2. 圖表樣式自定義
- 可增加配色方案選擇
- 可增加圖表尺寸設定

### 3. 批量生成優化
- 可增加進度條顯示
- 可增加平行處理

## 常見問題 FAQ

### Q1: 執行 TestSingleChart 出現錯誤 '5'
**A**: 已修復。確保使用最新版本的 `CreateChartSafely` 函數。

### Q2: Y 軸顯示小數刻度
**A**: 已修復。使用 `ConfigureDistributionChart_New` 函數自動設定整數刻度。

### Q3: MAX/Min 特殊點不顯示
**A**: 檢查以下條件：
1. `specMax/specMin` 是否有效（不是 `""` 或 `"*"`）
2. 該值是否已存在於普通讀值中
3. `WriteDistributionDataToSheet_New` 是否正確調用

### Q4: 參數表不顯示
**A**: 參數表只在有參數時顯示。檢查：
1. `specMax` 或 `specMin` 至少有一個有效
2. `hasParams` 邏輯是否正確

### Q5: 圖表位置不正確
**A**: 檢查：
1. `startCol` 計算是否正確（應為 `dataCol + 4`）
2. `CreateChartSafely` 的 `chartCol` 參數是否正確傳遞

## 修改歷史

### 2025-12-07
- ✅ 修復圖表創建錯誤 '5'
- ✅ 新增 `CreateChartSafely` 雙重嘗試機制
- ✅ 實現水平三區塊佈局
- ✅ 新增 MAX/Min 特殊點嵌入功能
- ✅ 新增 Y 軸整數刻度設定
- ✅ 新增智能參數匹配功能
- ✅ 重寫 `TestSingleChart` 測試函數
- ✅ 新增完整錯誤處理機制

## 文件位置

- **主要 VBA 文件**：`分布圖功能_修正版_可執行.txt`
- **獨立完整版**：`分布圖功能_超級完整獨立版_整合修復.txt`
- **本摘要文件**：`分布圖功能_修改完成摘要.md`

---

**備註**：所有修改已整合至主文件，可直接複製到 Excel VBA 編輯器中使用。
